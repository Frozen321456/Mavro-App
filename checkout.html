<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Essence</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background: #f9f9f9; padding: 40px 0; font-family: 'Plus Jakarta Sans', sans-serif; }
        .box { background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); height: 100%; }
        .dark-box { background: #111; color: #fff; padding: 30px; border-radius: 15px; position: sticky; top: 20px; }
        .form-control { border-radius: 8px; padding: 12px; margin-bottom: 15px; border: 1px solid #eee; }
        .btn-order { background: #ff5a5f; color: #fff; width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: 700; margin-top: 20px; font-size: 18px; }
        .order-id-popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; align-items: center; justify-content: center; color: white; text-align: center; }
        .summary-item { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; opacity: 0.9; }
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 10000; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #ff5a5f; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .variation-details { font-size: 11px; color: #999; margin-top: 2px; }
    </style>
</head>
<body>

<div class="loading" id="loading">
    <div class="spinner"></div>
    <p style="margin-top: 20px;">Processing your order...</p>
</div>

<div class="container">
    <div class="row g-4">
        <div class="col-md-7">
            <div class="box">
                <h4 class="mb-4">Shipping Information</h4>
                <div class="row">
                    <div class="col-md-12">
                        <label class="form-label">Full Name *</label>
                        <input type="text" id="fname" class="form-control" placeholder="Enter your full name" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Phone Number *</label>
                        <input type="tel" id="phone" class="form-control" placeholder="017XXXXXXXX" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email (Optional)</label>
                        <input type="email" id="email" class="form-control" placeholder="email@example.com">
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Full Address *</label>
                        <textarea id="addr" class="form-control" rows="3" placeholder="House, Road, Area, City" required></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">City</label>
                        <input type="text" id="city" class="form-control" value="Dhaka" placeholder="City">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Postcode</label>
                        <input type="text" id="postcode" class="form-control" value="1200" placeholder="Postcode">
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="dark-box">
                <h4 class="mb-4">Your Order Summary</h4>
                <div id="summaryItems"></div>
                <hr style="border-color: #444;">
                <div class="d-flex justify-content-between align-items-center">
                    <span style="font-size: 18px;">Total Payable</span>
                    <h3 id="totalPrice" style="color: #ff5a5f; margin: 0;">৳ 0</h3>
                </div>
                <button class="btn-order" onclick="placeOrder()">Confirm Order (COD)</button>
                <p class="text-center mt-3" style="font-size: 12px; opacity: 0.7;">Cash on Delivery only</p>
            </div>
        </div>
    </div>
</div>

<div id="successPopup" class="order-id-popup">
    <div class="p-4">
        <h1 style="color: #4BB543;">✓</h1>
        <h2>Order Successful!</h2>
        <p class="mt-2">Order ID: <span id="finalId" style="color: #ff5a5f; font-weight: bold;"></span></p>
        <p style="font-size: 14px; opacity: 0.8;">Track your order at: track-order.html?id=<span id="trackId"></span></p>
        <button onclick="window.location.href='shop.html'" class="btn btn-outline-light mt-4">Continue Shopping</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAB7dyaJwkadV7asGOhj6TCN5it5pCWg10",
        authDomain: "espera-mavro-6ddc5.firebaseapp.com",
        projectId: "espera-mavro-6ddc5",
        storageBucket: "espera-mavro-6ddc5.appspot.com",
        messagingSenderId: "137893255543",
        appId: "1:137893255543:web:a660bd412eb26ee322a972"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Enable persistence
    db.enablePersistence()
        .catch((err) => {
            console.log("Persistence failed:", err);
        });

    // MoveDrop API Configuration
    const MOVEDROP_API_KEY = 'MAVRO-ESSENCE-SECURE-KEY-2026';
    const MOVEDROP_API_URL = 'https://mavro.xo.je/api/index.php';

    // Load Cart & UI
    const cart = JSON.parse(localStorage.getItem('essence_cart')) || [];
    let grandTotal = 0;

    const loadUI = () => {
        const list = document.getElementById('summaryItems');
        list.innerHTML = "";
        grandTotal = 0;

        cart.forEach((item, index) => {
            const price = parseFloat(item.price) || 0;
            grandTotal += price;
            
            let variationHtml = '';
            if (item.variation && item.variation.properties) {
                variationHtml = `<div class="variation-details">${item.variation.properties.map(p => p.value).join(' / ')}</div>`;
            }
            
            list.innerHTML += `
                <div class="summary-item">
                    <div>
                        <span>${item.name}</span>
                        ${variationHtml}
                    </div>
                    <span>৳ ${price.toFixed(2)}</span>
                </div>`;
        });
        document.getElementById('totalPrice').innerText = "৳ " + grandTotal.toFixed(2);
    };

    // Get Webhooks from Firestore
    async function getWebhooks() {
        try {
            const webhooksRef = db.collection("webhooks");
            const snapshot = await webhooksRef.get();
            return snapshot.docs.map(doc => doc.data());
        } catch (error) {
            console.log("No webhooks found or error:", error);
            return [];
        }
    }

    // Validate Bangladesh Phone Number
    function validateBDPhone(phone) {
        const bdPhoneRegex = /^(?:\+88|01)?\d{11}$/;
        return bdPhoneRegex.test(phone.replace(/[^0-9]/g, ''));
    }

    // Place Order Function
    window.placeOrder = async () => {
        // Get form values
        const name = document.getElementById('fname').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const addr = document.getElementById('addr').value.trim();
        const email = document.getElementById('email').value.trim();
        const city = document.getElementById('city').value.trim() || 'Dhaka';
        const postcode = document.getElementById('postcode').value.trim() || '1200';

        // Validation
        if(!name) {
            alert("Please enter your full name");
            return;
        }
        if(!phone) {
            alert("Please enter your phone number");
            return;
        }
        if(!validateBDPhone(phone)) {
            alert("Please enter a valid Bangladesh phone number (11 digits)");
            return;
        }
        if(!addr) {
            alert("Please enter your address");
            return;
        }
        if(cart.length === 0) {
            alert("Your cart is empty");
            return;
        }

        // Show loading
        document.getElementById('loading').style.display = 'flex';

        // Generate order number
        const orderNumber = "MD-" + Date.now().toString().slice(-8) + "-" + Math.random().toString(36).substring(2, 6).toUpperCase();

        // Split name into first and last
        const nameParts = name.split(' ');
        const firstName = nameParts[0] || name;
        const lastName = nameParts.slice(1).join(' ') || "";

        // Prepare order data (MoveDrop format)
        const orderData = {
            order_number: orderNumber,
            status: "pending",
            currency: "BDT",
            total: grandTotal.toFixed(2),
            payment_method: "cod",
            shipping_address: {
                first_name: firstName,
                last_name: lastName,
                email: email || "no-email@store.com",
                phone: phone,
                address_1: addr,
                address_2: "",
                city: city,
                state: "Dhaka",
                postcode: postcode,
                country: "Bangladesh"
            },
            customer_notes: "",
            line_items: cart.map((item, index) => {
                // Generate variation info
                const variations = [];
                if (item.variation) {
                    variations.push({
                        id: index + 1,
                        variation_id: parseInt(item.variation.sku?.replace(/\D/g, '')) || index + 1,
                        sku: item.variation.sku || item.sku,
                        quantity: 1,
                        price: item.price
                    });
                }
                
                return {
                    id: index + 1,
                    product_id: parseInt(item.productId?.replace(/\D/g, '')) || 0,
                    name: item.name,
                    quantity: 1,
                    total: item.price,
                    variations: variations
                };
            }),
            created_at: new Date().toISOString()
        };

        try {
            // 1. Save to Firebase
            const docRef = await db.collection("orders").add({
                order_number: orderNumber,
                status: "pending",
                currency: "BDT",
                total: grandTotal.toFixed(2),
                payment_method: "cod",
                shipping_address: orderData.shipping_address,
                customer: {
                    name: name,
                    phone: phone,
                    email: email || "",
                    address: addr
                },
                customer_notes: "",
                line_items: cart.map(item => ({
                    id: item.id || item.productId,
                    name: item.name,
                    price: item.price,
                    sku: item.sku,
                    variation: item.variation
                })),
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            });

            console.log("Order saved to Firebase with ID:", docRef.id);

            // 2. Send to MoveDrop via API
            try {
                const response = await fetch(`${MOVEDROP_API_URL}?path=orders`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-API-KEY': MOVEDROP_API_KEY 
                    },
                    body: JSON.stringify(orderData)
                });
                
                const responseData = await response.json();
                if (!response.ok) {
                    console.log("API sync warning:", responseData);
                } else {
                    console.log("MoveDrop sync success:", responseData);
                }
            } catch (apiError) {
                console.log("API sync failed but order saved locally:", apiError);
            }

            // 3. Trigger webhooks
            const webhooks = await getWebhooks();
            for (const webhook of webhooks) {
                if (webhook.event === 'order.created') {
                    try {
                        await fetch(webhook.delivery_url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                id: docRef.id,
                                order_number: orderNumber,
                                status: "pending",
                                currency: "BDT",
                                total: grandTotal.toFixed(2),
                                payment_method: "cod",
                                shipping_address: orderData.shipping_address,
                                line_items: orderData.line_items,
                                created_at: new Date().toISOString()
                            })
                        });
                    } catch (webhookError) {
                        console.log("Webhook failed:", webhookError);
                    }
                }
            }

            // Hide loading
            document.getElementById('loading').style.display = 'none';

            // Show success
            document.getElementById('finalId').innerText = docRef.id;
            document.getElementById('trackId').innerText = docRef.id;
            document.getElementById('successPopup').style.display = "flex";
            
            // Clear cart
            localStorage.removeItem('essence_cart');

        } catch (e) {
            document.getElementById('loading').style.display = 'none';
            console.error("Order failed:", e);
            alert("Order failed! Please try again. Error: " + e.message);
        }
    };

    loadUI();
</script>
</body>
</html>
