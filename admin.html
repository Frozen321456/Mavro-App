<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin | Espera Mavro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --dark: #111; 
            --bg: #f8f9fa;
            --primary: #000000;
            --accent: #ff385c;
            --success: #2e7d32;
            --warning: #ed6c02;
            --info: #0288d1;
            --danger: #d32f2f;
            --coupon: #9c27b0;
        }
        
        body { background: var(--bg); font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        /* Hamburger Menu Styles */
        .hamburger-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 1001;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: 0.3s;
        }

        .hamburger-btn:hover {
            background: var(--accent);
            transform: scale(1.05);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1002;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .sidebar { 
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background: #fff;
            z-index: 1003;
            transition: 0.3s;
            padding: 80px 20px 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar.active { 
            left: 0;
        }

        .sidebar-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            transition: 0.2s;
        }

        .sidebar-close:hover {
            color: var(--accent);
        }

        .sidebar-logo {
            font-size: 20px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .sidebar-logo span {
            color: var(--accent);
        }

        .sidebar .nav-link { 
            color: #333; 
            padding: 12px 15px; 
            border-radius: 12px; 
            margin-bottom: 5px; 
            cursor: pointer; 
            text-decoration: none; 
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
        }
        
        .sidebar .nav-link:hover { 
            background: #f5f5f5; 
        }
        
        .sidebar .nav-link.active { 
            background: var(--primary); 
            color: #fff; 
        }
        
        .sidebar .nav-link i { 
            width: 24px; 
            font-size: 18px; 
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-section-title {
            font-size: 12px;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 20px 0 10px;
            padding-left: 15px;
        }
        
        .main { 
            margin-left: 0;
            padding: 80px 30px 30px;
            transition: 0.3s;
        }

        @media (max-width: 768px) { 
            .main { 
                padding: 80px 15px 15px;
            } 
        }
        
        .card-custom { 
            background: #fff; 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); 
            margin-bottom: 25px; 
            border: 1px solid #eee; 
        }
        
        .product-img { 
            width: 50px; 
            height: 65px; 
            object-fit: cover; 
            border-radius: 8px; 
            background: #eee; 
        }

        .gallery-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-top: 15px; 
        }

        .gallery-item { 
            position: relative; 
            width: 70px; 
            height: 70px; 
        }

        .gallery-item img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            border-radius: 8px; 
            border: 1px solid #ddd; 
        }

        .remove-btn { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            background: #ff4d4d; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 22px; 
            height: 22px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
        }

        .upload-trigger { 
            border: 2px dashed #000; 
            padding: 20px; 
            border-radius: 10px; 
            text-align: center; 
            cursor: pointer; 
            background: #fff; 
            font-weight: bold;
            transition: 0.2s;
        }

        .upload-trigger:hover {
            background: #f5f5f5;
            border-color: var(--accent);
        }

        #editor { 
            height: 300px; 
            background: white; 
        }
        
        .variation-row { 
            background: #f9f9f9; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            border: 1px solid #eee;
        }
        
        .status-badge { 
            padding: 6px 12px; 
            border-radius: 50px; 
            font-size: 12px; 
            font-weight: 600; 
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-pending { background: #fff3cd; color: #856404; }
        .status-placed { background: #d4edda; color: #155724; }
        .status-processing { background: #cce5ff; color: #004085; }
        .status-shipping { background: #d1ecf1; color: #0c5460; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .status-awaiting_verification { background: #fff3cd; color: #856404; border-left: 3px solid var(--warning); }
        .status-active { background: #d4edda; color: #155724; }
        .status-expired { background: #f8d7da; color: #721c24; }
        
        .payment-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
        }
        
        .payment-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
        }
        
        .payment-detail:last-child {
            border-bottom: none;
        }
        
        .verify-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .verify-btn:hover { background: #1e5622; }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border-radius: 30px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            transition: 0.2s;
            font-size: 13px;
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .stat-card h3 { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .stat-card p { opacity: 0.9; margin-bottom: 0; }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }

        .delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .delete-btn:hover { background: #b71c1c; }

        .variant-image-preview {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            margin-top: 5px;
        }

        .payment-type-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .payment-type-advance { background: #fff3cd; color: #856404; }
        .payment-type-full { background: #d4edda; color: #155724; }

        .coupon-badge {
            background: var(--coupon);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .excluded-item {
            background: #f5f5f5;
            padding: 5px 10px;
            border-radius: 15px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin: 2px;
        }

        .section-group {
            margin-bottom: 40px;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            font-size: 24px;
        }

        .preview-img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .live-preview {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .image-preview {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #ddd;
            margin-top: 10px;
        }

        .upload-area {
            border: 2px dashed var(--accent);
            padding: 30px;
            text-align: center;
            border-radius: 15px;
            background: #f9f9f9;
            cursor: pointer;
            transition: 0.2s;
        }

        .upload-area:hover {
            background: #f0f0f0;
            border-color: var(--primary);
        }

        .upload-area i {
            font-size: 40px;
            color: var(--accent);
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<!-- Hamburger Button -->
<button class="hamburger-btn" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</button>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-close" onclick="toggleSidebar()">
        <i class="fas fa-times"></i>
    </div>
    <div class="sidebar-logo">
        ESPERA <span>MAVRO</span>
    </div>
    
    <div class="sidebar-section">
        <div class="sidebar-section-title">Main</div>
        <a class="nav-link active" onclick="showSection('dashboard', this); toggleSidebar()">
            <i class="fa fa-dashboard"></i> Dashboard
        </a>
    </div>

    <div class="sidebar-section">
        <div class="sidebar-section-title">Page Sections</div>
        <a class="nav-link" onclick="showSection('sections', this); toggleSidebar()">
            <i class="fa fa-layers"></i> All Sections
        </a>
        <a class="nav-link" onclick="showSection('hero', this); toggleSidebar()">
            <i class="fa fa-image"></i> Hero Section
        </a>
        <a class="nav-link" onclick="showSection('banners', this); toggleSidebar()">
            <i class="fa fa-images"></i> Banners
        </a>
        <a class="nav-link" onclick="showSection('services', this); toggleSidebar()">
            <i class="fa fa-cubes"></i> Services
        </a>
        <a class="nav-link" onclick="showSection('trust', this); toggleSidebar()">
            <i class="fa fa-shield-alt"></i> Trust Badges
        </a>
        <a class="nav-link" onclick="showSection('footer', this); toggleSidebar()">
            <i class="fa fa-foot"></i> Footer
        </a>
        <a class="nav-link" onclick="showSection('reviews', this); toggleSidebar()">
            <i class="fa fa-star"></i> Reviews
        </a>
    </div>

    <div class="sidebar-section">
        <div class="sidebar-section-title">Shop Management</div>
        <a class="nav-link" onclick="showSection('products', this); toggleSidebar()">
            <i class="fa fa-box"></i> Products
        </a>
        <a class="nav-link" onclick="showSection('categories', this); toggleSidebar()">
            <i class="fa fa-list"></i> Categories
        </a>
        <a class="nav-link" onclick="showSection('coupons', this); toggleSidebar()">
            <i class="fa fa-ticket"></i> Coupons
        </a>
    </div>

    <div class="sidebar-section">
        <div class="sidebar-section-title">Orders</div>
        <a class="nav-link" onclick="showSection('orders', this); toggleSidebar()">
            <i class="fa fa-shopping-cart"></i> Orders
        </a>
        <a class="nav-link" onclick="showSection('payment-verification', this); toggleSidebar()">
            <i class="fa fa-check-circle"></i> Payment Verification
            <span class="badge bg-danger ms-auto" id="pendingPaymentCount">0</span>
        </a>
    </div>

    <div class="sidebar-section">
        <div class="sidebar-section-title">Analytics</div>
        <a class="nav-link" onclick="showSection('analytics', this); toggleSidebar()">
            <i class="fa fa-chart-line"></i> Analytics
        </a>
    </div>
</div>

<div class="main" id="main">
    <!-- Dashboard -->
    <div id="dashboard" class="section">
        <h3 class="mb-4">Dashboard Overview</h3>
        <div class="row g-4">
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Total Products</h6>
                    <h2 id="totalProducts">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Total Orders</h6>
                    <h2 id="totalOrders">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Active Coupons</h6>
                    <h2 id="activeCoupons">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Pending Verification</h6>
                    <h2 id="pendingVerificationCount">0</h2>
                </div>
            </div>
        </div>
        
        <div class="row g-4 mt-2">
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Completed Orders</h6>
                    <h2 id="completedCount">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Total Revenue</h6>
                    <h2 id="totalRevenue">৳0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Today's Orders</h6>
                    <h2 id="todayOrders">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Avg Order Value</h6>
                    <h2 id="avgOrderValue">৳0</h2>
                </div>
            </div>
        </div>
        
        <div class="card-custom mt-4">
            <h5>Quick Actions</h5>
            <div class="row g-3 mt-2">
                <div class="col-md-2">
                    <button class="btn btn-outline-dark w-100 py-2" onclick="showSection('hero', document.querySelector('[onclick*=\"hero\"]')); toggleSidebar()">
                        <i class="fa fa-image"></i> Hero
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-dark w-100 py-2" onclick="showSection('banners', document.querySelector('[onclick*=\"banners\"]')); toggleSidebar()">
                        <i class="fa fa-images"></i> Banners
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-dark w-100 py-2" onclick="showSection('services', document.querySelector('[onclick*=\"services\"]')); toggleSidebar()">
                        <i class="fa fa-cubes"></i> Services
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-dark w-100 py-2" onclick="showSection('products', document.querySelector('[onclick*=\"products\"]')); toggleSidebar()">
                        <i class="fa fa-box"></i> Products
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-dark w-100 py-2" onclick="showSection('orders', document.querySelector('[onclick*=\"orders\"]')); toggleSidebar()">
                        <i class="fa fa-shopping-cart"></i> Orders
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-dark w-100 py-2" onclick="showSection('payment-verification', document.querySelector('[onclick*=\"payment-verification\"]')); toggleSidebar()">
                        <i class="fa fa-check-circle"></i> Payments
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card-custom mt-4">
            <h5>Recent Orders</h5>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Payment Type</th>
                            <th>Paid Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="recentOrdersList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Sections Overview -->
    <div id="sections" class="section" style="display: none;">
        <h3 class="mb-4">Page Sections Control</h3>
        
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card-custom">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fa fa-image fa-2x me-3" style="color: var(--accent);"></i>
                        <div>
                            <h5 class="mb-1">Hero Section</h5>
                            <p class="text-muted small">Main banner with tagline and image</p>
                        </div>
                    </div>
                    <button class="btn btn-dark w-100" onclick="showSection('hero', document.querySelector('[onclick*=\"hero\"]'))">
                        Edit Hero
                    </button>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card-custom">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fa fa-images fa-2x me-3" style="color: var(--accent);"></i>
                        <div>
                            <h5 class="mb-1">Banners</h5>
                            <p class="text-muted small">Left and right promotional banners</p>
                        </div>
                    </div>
                    <button class="btn btn-dark w-100" onclick="showSection('banners', document.querySelector('[onclick*=\"banners\"]'))">
                        Edit Banners
                    </button>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card-custom">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fa fa-cubes fa-2x me-3" style="color: var(--accent);"></i>
                        <div>
                            <h5 class="mb-1">Services</h5>
                            <p class="text-muted small">4 service cards with icons</p>
                        </div>
                    </div>
                    <button class="btn btn-dark w-100" onclick="showSection('services', document.querySelector('[onclick*=\"services\"]'))">
                        Edit Services
                    </button>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card-custom">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fa fa-shield-alt fa-2x me-3" style="color: var(--accent);"></i>
                        <div>
                            <h5 class="mb-1">Trust Badges</h5>
                            <p class="text-muted small">4 trust indicators</p>
                        </div>
                    </div>
                    <button class="btn btn-dark w-100" onclick="showSection('trust', document.querySelector('[onclick*=\"trust\"]'))">
                        Edit Trust Badges
                    </button>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card-custom">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fa fa-foot fa-2x me-3" style="color: var(--accent);"></i>
                        <div>
                            <h5 class="mb-1">Footer</h5>
                            <p class="text-muted small">Footer content, social links, contact</p>
                        </div>
                    </div>
                    <button class="btn btn-dark w-100" onclick="showSection('footer', document.querySelector('[onclick*=\"footer\"]'))">
                        Edit Footer
                    </button>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card-custom">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fa fa-star fa-2x me-3" style="color: var(--accent);"></i>
                        <div>
                            <h5 class="mb-1">Reviews</h5>
                            <p class="text-muted small">Customer reviews management</p>
                        </div>
                    </div>
                    <button class="btn btn-dark w-100" onclick="showSection('reviews', document.querySelector('[onclick*=\"reviews\"]'))">
                        Manage Reviews
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hero Section Editor with Image Upload -->
    <div id="hero" class="section" style="display: none;">
        <h3 class="mb-4">Hero Section Editor</h3>
        
        <div class="card-custom">
            <div class="row g-4">
                <div class="col-md-6">
                    <label class="small fw-bold">Tag Line</label>
                    <input type="text" id="heroTag" class="form-control" placeholder="e.g., CHINA TO BANGLADESH" oninput="updateHeroPreview()">
                </div>
                
                <div class="col-md-6">
                    <label class="small fw-bold">Title (use &lt;br&gt; for line break)</label>
                    <input type="text" id="heroTitle" class="form-control" placeholder="e.g., Global&lt;br&gt;Wholesale" oninput="updateHeroPreview()">
                </div>
                
                <div class="col-md-6">
                    <label class="small fw-bold">Description Text</label>
                    <input type="text" id="heroText" class="form-control" placeholder="e.g., Premium sourcing with door-to-door shipping" oninput="updateHeroPreview()">
                </div>
                
                <div class="col-md-6">
                    <label class="small fw-bold">Button Text</label>
                    <input type="text" id="heroBtnText" class="form-control" placeholder="SHOP NOW" oninput="updateHeroPreview()">
                </div>
                
                <div class="col-md-6">
                    <label class="small fw-bold">Button Link</label>
                    <input type="text" id="heroBtnLink" class="form-control" value="shop.html">
                </div>
                
                <div class="col-md-6">
                    <label class="small fw-bold">Hero Image</label>
                    <div class="upload-area" onclick="document.getElementById('heroImageUpload').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Click to upload hero image</p>
                        <small class="text-muted">PNG, JPG, GIF up to 5MB</small>
                    </div>
                    <input type="file" id="heroImageUpload" class="d-none" accept="image/*" onchange="handleHeroImageUpload(this)">
                    <input type="hidden" id="heroImage" value="">
                    <div id="heroImagePreview" class="mt-3 text-center"></div>
                </div>
                
                <div class="col-12">
                    <div class="live-preview">
                        <h6>Live Preview:</h6>
                        <div style="background: #111; color: white; padding: 20px; border-radius: 10px; position: relative; min-height: 200px; background-size: cover; background-position: center;" id="heroPreviewBg">
                            <div style="position: relative; z-index: 2;">
                                <span id="previewTag" style="color: #c5a059; font-size: 12px;">CHINA TO BANGLADESH</span>
                                <h3 id="previewTitle" style="font-size: 24px;">Global<br>Wholesale</h3>
                                <p id="previewText" style="font-size: 14px;">Premium sourcing with door-to-door shipping</p>
                                <span id="previewBtn" style="background: white; color: black; padding: 5px 15px; border-radius: 20px; font-size: 12px; display: inline-block;">SHOP NOW</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12">
                    <button class="btn btn-dark w-100 py-3" onclick="saveHeroSection()">
                        <i class="fas fa-save"></i> SAVE HERO SECTION
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Banners Editor with Image Upload -->
    <div id="banners" class="section" style="display: none;">
        <h3 class="mb-4">Banners Editor</h3>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card-custom">
                    <h5>Left Banner</h5>
                    <div class="mb-3">
                        <label class="small fw-bold">Tag</label>
                        <input type="text" id="leftBannerTag" class="form-control" placeholder="SUMMER 26">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Title</label>
                        <input type="text" id="leftBannerTitle" class="form-control" placeholder="Essentials">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Text</label>
                        <input type="text" id="leftBannerText" class="form-control" placeholder="up to 40% off">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Banner Image</label>
                        <div class="upload-area" onclick="document.getElementById('leftBannerUpload').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Click to upload banner image</p>
                        </div>
                        <input type="file" id="leftBannerUpload" class="d-none" accept="image/*" onchange="handleBannerImageUpload(this, 'left')">
                        <input type="hidden" id="leftBannerImage" value="">
                        <div id="leftBannerPreview" class="mt-2"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card-custom">
                    <h5>Right Banner</h5>
                    <div class="mb-3">
                        <label class="small fw-bold">Tag</label>
                        <input type="text" id="rightBannerTag" class="form-control" placeholder="BAGS">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Title</label>
                        <input type="text" id="rightBannerTitle" class="form-control" placeholder="Leather">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Text</label>
                        <input type="text" id="rightBannerText" class="form-control" placeholder="wholesale price">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Banner Image</label>
                        <div class="upload-area" onclick="document.getElementById('rightBannerUpload').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Click to upload banner image</p>
                        </div>
                        <input type="file" id="rightBannerUpload" class="d-none" accept="image/*" onchange="handleBannerImageUpload(this, 'right')">
                        <input type="hidden" id="rightBannerImage" value="">
                        <div id="rightBannerPreview" class="mt-2"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-12">
                <button class="btn btn-dark w-100 py-3" onclick="saveBanners()">
                    <i class="fas fa-save"></i> SAVE BANNERS
                </button>
            </div>
        </div>
    </div>

    <!-- Services Editor -->
    <div id="services" class="section" style="display: none;">
        <h3 class="mb-4">Services Editor</h3>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card-custom">
                    <h5>Service 1</h5>
                    <div class="mb-3">
                        <label class="small fw-bold">Icon (Font Awesome class)</label>
                        <input type="text" id="service1Icon" class="form-control" value="fa-truck-fast">
                        <small class="text-muted">e.g., fa-truck-fast, fa-hand-holding-dollar</small>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Title</label>
                        <input type="text" id="service1Title" class="form-control" value="Door-to-Door">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Description</label>
                        <input type="text" id="service1Desc" class="form-control" value="China-BD express">
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card-custom">
                    <h5>Service 2</h5>
                    <div class="mb-3">
                        <label class="small fw-bold">Icon</label>
                        <input type="text" id="service2Icon" class="form-control" value="fa-hand-holding-dollar">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Title</label>
                        <input type="text" id="service2Title" class="form-control" value="Wholesale">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Description</label>
                        <input type="text" id="service2Desc" class="form-control" value="low MOQ">
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card-custom">
                    <h5>Service 3</h5>
                    <div class="mb-3">
                        <label class="small fw-bold">Icon</label>
                        <input type="text" id="service3Icon" class="form-control" value="fa-shield">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Title</label>
                        <input type="text" id="service3Title" class="form-control" value="Secure Payment">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Description</label>
                        <input type="text" id="service3Desc" class="form-control" value="escrow available">
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card-custom">
                    <h5>Service 4</h5>
                    <div class="mb-3">
                        <label class="small fw-bold">Icon</label>
                        <input type="text" id="service4Icon" class="form-control" value="fa-clock">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Title</label>
                        <input type="text" id="service4Title" class="form-control" value="24/7 Support">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Description</label>
                        <input type="text" id="service4Desc" class="form-control" value="chat with us">
                    </div>
                </div>
            </div>
            
            <div class="col-12">
                <button class="btn btn-dark w-100 py-3" onclick="saveServices()">
                    <i class="fas fa-save"></i> SAVE SERVICES
                </button>
            </div>
        </div>
    </div>

    <!-- Trust Badges Editor -->
    <div id="trust" class="section" style="display: none;">
        <h3 class="mb-4">Trust Badges Editor</h3>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card-custom">
                    <h5>Badge 1</h5>
                    <div class="mb-3">
                        <label class="small fw-bold">Icon</label>
                        <input type="text" id="trust1Icon" class="form-control" value="fa-circle-check">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Text</label>
                        <input type="text" id="trust1Text" class="form-control" value="Verified">
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card-custom">
                    <h5>Badge 2</h5>
                    <div class="mb-3">
                        <label class="small fw-bold">Icon</label>
                        <input type="text" id="trust2Icon" class="form-control" value="fa-gem">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Text</label>
                        <input type="text" id="trust2Text" class="form-control" value="Premium">
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card-custom">
                    <h5>Badge 3</h5>
                    <div class="mb-3">
                        <label class="small fw-bold">Icon</label>
                        <input type="text" id="trust3Icon" class="form-control" value="fa-credit-card">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Text</label>
                        <input type="text" id="trust3Text" class="form-control" value="Secure">
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card-custom">
                    <h5>Badge 4</h5>
                    <div class="mb-3">
                        <label class="small fw-bold">Icon</label>
                        <input type="text" id="trust4Icon" class="form-control" value="fa-clock">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Text</label>
                        <input type="text" id="trust4Text" class="form-control" value="Fast">
                    </div>
                </div>
            </div>
            
            <div class="col-12">
                <button class="btn btn-dark w-100 py-3" onclick="saveTrustBadges()">
                    <i class="fas fa-save"></i> SAVE TRUST BADGES
                </button>
            </div>
        </div>
    </div>

    <!-- Footer Editor -->
    <div id="footer" class="section" style="display: none;">
        <h3 class="mb-4">Footer Editor</h3>
        
        <div class="card-custom">
            <h5>About Text</h5>
            <textarea id="footerAbout" class="form-control" rows="3">Premium global sourcing platform connecting Bangladesh businesses with international suppliers. Door-to-door delivery, wholesale pricing, and reliable fulfillment.</textarea>
        </div>
        
        <div class="card-custom">
            <h5>Social Links</h5>
            <div class="row">
                <div class="col-md-6">
                    <label class="small fw-bold">Facebook</label>
                    <input type="text" id="socialFb" class="form-control" value="#">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Instagram</label>
                    <input type="text" id="socialIg" class="form-control" value="#">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">WhatsApp</label>
                    <input type="text" id="socialWa" class="form-control" value="#">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">LinkedIn</label>
                    <input type="text" id="socialLi" class="form-control" value="#">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">YouTube</label>
                    <input type="text" id="socialYt" class="form-control" value="#">
                </div>
            </div>
        </div>
        
        <div class="card-custom">
            <h5>Contact Information</h5>
            <div class="row">
                <div class="col-md-6">
                    <label class="small fw-bold">Address</label>
                    <input type="text" id="contactAddress" class="form-control" value="Dhaka, Bangladesh">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Phone</label>
                    <input type="text" id="contactPhone" class="form-control" value="+880 1721-383418">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Email</label>
                    <input type="email" id="contactEmail" class="form-control" value="esperamavro@gmail.com">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Hours</label>
                    <input type="text" id="contactHours" class="form-control" value="Support: 24/7">
                </div>
            </div>
        </div>
        
        <div class="card-custom">
            <h5>Copyright Text</h5>
            <input type="text" id="copyrightText" class="form-control" value="© 2026 <strong>Espera Mavro</strong>. All rights reserved. Global Sourcing Platform">
        </div>
        
        <button class="btn btn-dark w-100 py-3" onclick="saveFooter()">
            <i class="fas fa-save"></i> SAVE FOOTER
        </button>
    </div>

    <!-- Reviews Management -->
    <div id="reviews" class="section" style="display: none;">
        <h3 class="mb-4">Reviews Management</h3>
        
        <div class="card-custom">
            <h5>All Customer Reviews</h5>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Rating</th>
                            <th>Review</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="reviewsList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Analytics Section -->
    <div id="analytics" class="section" style="display: none;">
        <h3 class="mb-4">Analytics Dashboard</h3>
        
        <div class="row g-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <p>Total Revenue</p>
                    <h3 id="analyticsRevenue">৳0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <p>Total Orders</p>
                    <h3 id="analyticsOrders">0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <p>Total Products</p>
                    <h3 id="analyticsProducts">0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <p>Coupon Usage</p>
                    <h3 id="couponUsageCount">0</h3>
                </div>
            </div>
        </div>

        <div class="row g-4 mt-2">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="ordersChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row g-4 mt-2">
            <div class="col-md-4">
                <div class="card-custom">
                    <h5>Payment Types</h5>
                    <canvas id="paymentChart" style="height: 200px;"></canvas>
                    <div class="mt-3" id="paymentStats"></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-custom">
                    <h5>Order Status</h5>
                    <canvas id="statusChart" style="height: 200px;"></canvas>
                    <div class="mt-3" id="statusStats"></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-custom">
                    <h5>Top Products</h5>
                    <div id="topProductsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Section -->
    <div id="products" class="section" style="display: none;">
        <div class="card-custom">
            <h5 class="mb-4 fw-bold">Publish New Product</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="small fw-bold">Product Name *</label>
                    <input type="text" id="pName" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold">SKU *</label>
                    <input type="text" id="pSku" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold">Price (৳) *</label>
                    <input type="number" id="pPrice" class="form-control">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Category</label>
                    <select id="pCatSel" class="form-select">
                        <option value="">Select Category</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Main Image *</label>
                    <input type="file" id="pImg" class="form-control" accept="image/*">
                </div>
                <div class="col-12">
                    <label class="small fw-bold">Gallery Images</label>
                    <div class="upload-trigger" onclick="document.getElementById('galleryInput').click()">+ Add Gallery Images</div>
                    <input type="file" id="galleryInput" class="d-none" multiple accept="image/*">
                    <div id="galleryContainer" class="gallery-container"></div>
                </div>
                <div class="col-12">
                    <h5>Variations</h5>
                    <button class="btn btn-sm btn-outline-dark mb-2" onclick="addVariation()">+ Add Variation</button>
                    <div id="variationsContainer"></div>
                </div>
                <div class="col-12">
                    <label class="small fw-bold">Description</label>
                    <div id="editor"></div>
                </div>
                <div class="col-12">
                    <button id="savePBtn" class="btn btn-dark w-100 py-3 mt-3 fw-bold">PUBLISH PRODUCT</button>
                </div>
            </div>
        </div>

        <div class="card-custom">
            <h5>Live Inventory</h5>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Price</th>
                            <th>Variations</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="pList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Categories Section -->
    <div id="categories" class="section" style="display: none;">
        <div class="card-custom">
            <h5>Manage Categories</h5>
            <div class="input-group mb-3">
                <input type="text" id="catName" class="form-control" placeholder="Category Name">
                <button id="saveCatBtn" class="btn btn-dark">Add Category</button>
            </div>
            <div id="catList" class="d-flex flex-wrap gap-2"></div>
        </div>
    </div>

    <!-- Coupons Section -->
    <div id="coupons" class="section" style="display: none;">
        <h3 class="mb-4">Coupon Management</h3>
        
        <div class="card-custom">
            <h5 class="mb-3">Create New Coupon</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="small fw-bold">Coupon Code *</label>
                    <input type="text" id="couponCode" class="form-control" placeholder="e.g., SUMMER50">
                </div>
                <div class="col-md-4">
                    <label class="small fw-bold">Discount Type *</label>
                    <select id="discountType" class="form-select" onchange="toggleDiscountFields()">
                        <option value="fixed">Fixed Amount (৳)</option>
                        <option value="percentage">Percentage (%)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="small fw-bold">Discount Value *</label>
                    <input type="number" id="discountValue" class="form-control" placeholder="Enter amount">
                </div>
                
                <div class="col-md-4">
                    <label class="small fw-bold">Valid From</label>
                    <input type="datetime-local" id="validFrom" class="form-control">
                </div>
                <div class="col-md-4">
                    <label class="small fw-bold">Valid Until</label>
                    <input type="datetime-local" id="validUntil" class="form-control">
                </div>
                <div class="col-md-4">
                    <label class="small fw-bold">Usage Limit (0 = unlimited)</label>
                    <input type="number" id="usageLimit" class="form-control" value="0">
                </div>
                
                <div class="col-md-6">
                    <label class="small fw-bold">Minimum Order Amount (0 = no minimum)</label>
                    <input type="number" id="minOrderAmount" class="form-control" value="0">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Maximum Discount Amount (for percentage)</label>
                    <input type="number" id="maxDiscountAmount" class="form-control" value="0" placeholder="0 = no limit">
                </div>
                
                <div class="col-12">
                    <label class="small fw-bold">Exclude Products (Select products to exclude from discount)</label>
                    <select id="excludeProducts" class="form-select" multiple size="3">
                        <!-- Products will be loaded here -->
                    </select>
                    <small class="text-muted">Hold Ctrl/Cmd to select multiple products</small>
                </div>
                
                <div class="col-12">
                    <label class="small fw-bold">Exclude Categories (Select categories to exclude from discount)</label>
                    <select id="excludeCategories" class="form-select" multiple size="3">
                        <!-- Categories will be loaded here -->
                    </select>
                    <small class="text-muted">Hold Ctrl/Cmd to select multiple categories</small>
                </div>
                
                <div class="col-12">
                    <label class="small fw-bold">Description</label>
                    <textarea id="couponDescription" class="form-control" rows="2" placeholder="Optional description"></textarea>
                </div>
                
                <div class="col-12">
                    <button class="btn btn-dark w-100 py-3" onclick="createCoupon()">
                        <i class="fas fa-plus-circle"></i> CREATE COUPON
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card-custom">
            <h5 class="mb-3">Active Coupons</h5>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Discount</th>
                            <th>Valid From</th>
                            <th>Valid Until</th>
                            <th>Used/Total</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="couponsList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Payment Verification Section -->
    <div id="payment-verification" class="section" style="display: none;">
        <h3 class="mb-4">Payment Verification</h3>
        
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterPayments('all', this)">All</button>
            <button class="filter-btn" onclick="filterPayments('cod_advance', this)">COD Advance</button>
            <button class="filter-btn" onclick="filterPayments('full_payment', this)">Full Payment</button>
        </div>
        
        <div class="card-custom">
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Total Amount</th>
                            <th>Payment Type</th>
                            <th>Paid Amount</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="paymentVerificationList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Orders Section -->
    <div id="orders" class="section" style="display: none;">
        <h3 class="mb-4">Order Management</h3>
        
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterOrders('all', this)">All</button>
            <button class="filter-btn" onclick="filterOrders('pending', this)">Pending</button>
            <button class="filter-btn" onclick="filterOrders('placed', this)">Order Placed</button>
            <button class="filter-btn" onclick="filterOrders('processing', this)">Processing</button>
            <button class="filter-btn" onclick="filterOrders('shipping', this)">Shipping</button>
            <button class="filter-btn" onclick="filterOrders('completed', this)">Completed</button>
            <button class="filter-btn" onclick="filterOrders('cancelled', this)">Cancelled</button>
        </div>
        
        <div class="card-custom">
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Total</th>
                            <th>Payment Type</th>
                            <th>Paid</th>
                            <th>Due</th>
                            <th>Coupon</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="orderList"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAB7dyaJwkadV7asGOhj6TCN5it5pCWg10",
        authDomain: "espera-mavro-6ddc5.firebaseapp.com",
        databaseURL: "https://espera-mavro-6ddc5-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "espera-mavro-6ddc5",
        storageBucket: "espera-mavro-6ddc5.appspot.com",
        appId: "1:137893255543:web:a660bd412eb26ee322a972"
    };
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Initialize Quill
    const quill = new Quill('#editor', { theme: 'snow' });
    
    // State
    let galleryArr = [];
    let variations = [];
    let currentFilter = 'all';
    let currentPaymentFilter = 'all';
    let ordersChart, revenueChart, paymentChart, statusChart;
    let allProducts = [];
    let allCategories = [];

    // Toggle Sidebar
    window.toggleSidebar = () => {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('sidebarOverlay').classList.toggle('active');
    };

    // Navigation
    window.showSection = (id, el) => {
        document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        el.classList.add('active');
        
        // Load section data when opened
        if (id === 'hero') loadHeroData();
        if (id === 'banners') loadBannerData();
        if (id === 'services') loadServicesData();
        if (id === 'trust') loadTrustData();
        if (id === 'footer') loadFooterData();
        if (id === 'reviews') loadReviewsList();
        if (id === 'products') loadProducts();
        if (id === 'categories') loadCategories();
        if (id === 'coupons') {
            loadProductsForCoupon();
            loadCategoriesForCoupon();
            loadCoupons();
        }
        if (id === 'payment-verification') loadPaymentVerification();
        if (id === 'orders') loadOrders('all');
        if (id === 'analytics') loadAnalytics();
        if (id === 'dashboard') loadDashboard();
    };

    // ========== IMAGE UPLOAD FUNCTIONS ==========
    const toBase64 = f => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(f);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    // Hero Image Upload
    window.handleHeroImageUpload = async (input) => {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size should be less than 5MB');
                return;
            }
            
            const base64 = await toBase64(file);
            document.getElementById('heroImage').value = base64;
            
            // Show preview
            const previewDiv = document.getElementById('heroImagePreview');
            previewDiv.innerHTML = `<img src="${base64}" class="image-preview">`;
            
            // Update live preview background
            document.getElementById('heroPreviewBg').style.backgroundImage = `url('${base64}')`;
        }
    };

    // Banner Image Upload
    window.handleBannerImageUpload = async (input, position) => {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size should be less than 5MB');
                return;
            }
            
            const base64 = await toBase64(file);
            document.getElementById(`${position}BannerImage`).value = base64;
            
            // Show preview
            const previewDiv = document.getElementById(`${position}BannerPreview`);
            previewDiv.innerHTML = `<img src="${base64}" class="image-preview">`;
        }
    };

    // Gallery upload for products
    document.getElementById('galleryInput').onchange = async (e) => {
        for(let file of e.target.files) { 
            if (file.size > 5 * 1024 * 1024) {
                alert('Each image should be less than 5MB');
                continue;
            }
            galleryArr.push(await toBase64(file)); 
        }
        renderGallery();
    };

    function renderGallery() {
        const container = document.getElementById('galleryContainer');
        container.innerHTML = galleryArr.map((src, index) => `
            <div class="gallery-item">
                <img src="${src}">
                <button class="remove-btn" onclick="galleryArr.splice(${index},1);renderGallery()">×</button>
            </div>
        `).join('');
    }

    // ========== VARIATIONS ==========
    window.addVariation = () => {
        variations.push({ 
            name: '', 
            value: '', 
            price: '', 
            image: null,
            imagePreview: null 
        });
        renderVariations();
    };

    function renderVariations() {
        const container = document.getElementById('variationsContainer');
        container.innerHTML = variations.map((v, i) => `
            <div class="variation-row">
                <div class="row g-2">
                    <div class="col-md-3">
                        <input type="text" class="form-control" placeholder="Type (e.g., Color)" value="${v.name}" onchange="updateVariation(${i}, 'name', this.value)">
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" placeholder="Value (e.g., Red)" value="${v.value}" onchange="updateVariation(${i}, 'value', this.value)">
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" placeholder="Price" value="${v.price}" onchange="updateVariation(${i}, 'price', this.value)">
                    </div>
                    <div class="col-md-3">
                        <input type="file" class="form-control" accept="image/*" onchange="uploadVariationImage(${i}, this)">
                        ${v.imagePreview ? `<img src="${v.imagePreview}" class="variant-image-preview">` : ''}
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-outline-danger" onclick="removeVariation(${i})">×</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    window.updateVariation = (index, field, value) => {
        variations[index][field] = value;
    };

    window.uploadVariationImage = async (index, input) => {
        if (input.files && input.files[0]) {
            const base64 = await toBase64(input.files[0]);
            variations[index].image = base64;
            variations[index].imagePreview = base64;
            renderVariations();
        }
    };

    window.removeVariation = (index) => {
        variations.splice(index, 1);
        renderVariations();
    };

    // ========== SECTION LOAD FUNCTIONS ==========
    
    function loadHeroData() {
        database.ref('sections/hero').once('value', (snapshot) => {
            const data = snapshot.val() || {};
            document.getElementById('heroTag').value = data.tag || 'CHINA TO BANGLADESH';
            document.getElementById('heroTitle').value = data.title || 'Global<br>Wholesale';
            document.getElementById('heroText').value = data.text || 'Premium sourcing with door-to-door shipping';
            document.getElementById('heroBtnText').value = data.btn_text || 'SHOP NOW';
            document.getElementById('heroBtnLink').value = data.btn_link || 'shop.html';
            document.getElementById('heroImage').value = data.image || '';
            
            // Show image preview if exists
            if (data.image) {
                document.getElementById('heroImagePreview').innerHTML = `<img src="${data.image}" class="image-preview">`;
                document.getElementById('heroPreviewBg').style.backgroundImage = `url('${data.image}')`;
            }
            
            updateHeroPreview();
        });
    }

    function loadBannerData() {
        database.ref('sections/banners').once('value', (snapshot) => {
            const data = snapshot.val() || {};
            
            // Left banner
            const left = data.left || {};
            document.getElementById('leftBannerTag').value = left.tag || 'SUMMER 26';
            document.getElementById('leftBannerTitle').value = left.title || 'Essentials';
            document.getElementById('leftBannerText').value = left.text || 'up to 40% off';
            document.getElementById('leftBannerImage').value = left.image || '';
            if (left.image) {
                document.getElementById('leftBannerPreview').innerHTML = `<img src="${left.image}" class="image-preview">`;
            }
            
            // Right banner
            const right = data.right || {};
            document.getElementById('rightBannerTag').value = right.tag || 'BAGS';
            document.getElementById('rightBannerTitle').value = right.title || 'Leather';
            document.getElementById('rightBannerText').value = right.text || 'wholesale price';
            document.getElementById('rightBannerImage').value = right.image || '';
            if (right.image) {
                document.getElementById('rightBannerPreview').innerHTML = `<img src="${right.image}" class="image-preview">`;
            }
        });
    }

    function loadServicesData() {
        database.ref('sections/services').once('value', (snapshot) => {
            const data = snapshot.val() || {};
            
            for (let i = 1; i <= 4; i++) {
                const service = data[`service_${i}`] || {};
                document.getElementById(`service${i}Icon`).value = service.icon || ['fa-truck-fast', 'fa-hand-holding-dollar', 'fa-shield', 'fa-clock'][i-1];
                document.getElementById(`service${i}Title`).value = service.title || ['Door-to-Door', 'Wholesale', 'Secure Payment', '24/7 Support'][i-1];
                document.getElementById(`service${i}Desc`).value = service.desc || ['China-BD express', 'low MOQ', 'escrow available', 'chat with us'][i-1];
            }
        });
    }

    function loadTrustData() {
        database.ref('sections/trust').once('value', (snapshot) => {
            const data = snapshot.val() || {};
            
            const defaultIcons = ['fa-circle-check', 'fa-gem', 'fa-credit-card', 'fa-clock'];
            const defaultTexts = ['Verified', 'Premium', 'Secure', 'Fast'];
            
            for (let i = 1; i <= 4; i++) {
                const trust = data[`trust_${i}`] || {};
                document.getElementById(`trust${i}Icon`).value = trust.icon || defaultIcons[i-1];
                document.getElementById(`trust${i}Text`).value = trust.text || defaultTexts[i-1];
            }
        });
    }

    function loadFooterData() {
        database.ref('sections/footer').once('value', (snapshot) => {
            const data = snapshot.val() || {};
            
            document.getElementById('footerAbout').value = data.about_text || 'Premium global sourcing platform connecting Bangladesh businesses with international suppliers. Door-to-door delivery, wholesale pricing, and reliable fulfillment.';
            
            const social = data.social || {};
            document.getElementById('socialFb').value = social.facebook || '#';
            document.getElementById('socialIg').value = social.instagram || '#';
            document.getElementById('socialWa').value = social.whatsapp || '#';
            document.getElementById('socialLi').value = social.linkedin || '#';
            document.getElementById('socialYt').value = social.youtube || '#';
            
            const contact = data.contact || {};
            document.getElementById('contactAddress').value = contact.address || 'Dhaka, Bangladesh';
            document.getElementById('contactPhone').value = contact.phone || '+880 1721-383418';
            document.getElementById('contactEmail').value = contact.email || 'esperamavro@gmail.com';
            document.getElementById('contactHours').value = contact.hours || 'Support: 24/7';
            
            document.getElementById('copyrightText').value = data.copyright || '© 2026 <strong>Espera Mavro</strong>. All rights reserved. Global Sourcing Platform';
        });
    }

    function loadReviewsList() {
        const list = document.getElementById('reviewsList');
        list.innerHTML = '<tr><td colspan="5" class="text-center py-4">Loading...</td></tr>';
        
        database.ref('reviews').once('value', (snapshot) => {
            if (!snapshot.exists()) {
                list.innerHTML = '<tr><td colspan="5" class="text-center py-4">No reviews yet</td></tr>';
                return;
            }
            
            let html = '';
            snapshot.forEach((child) => {
                const review = child.val();
                const date = review.date ? new Date(review.date).toLocaleDateString() : 'N/A';
                
                html += `
                    <tr>
                        <td>${review.name || 'Anonymous'}</td>
                        <td>${'★'.repeat(review.rating || 5)}</td>
                        <td>${review.text || ''}</td>
                        <td>${date}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteReview('${child.key}')">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            list.innerHTML = html;
        });
    }

    function deleteReview(reviewId) {
        if (confirm('Delete this review?')) {
            database.ref('reviews/' + reviewId).remove()
                .then(() => {
                    alert('Review deleted');
                    loadReviewsList();
                })
                .catch(err => alert('Error deleting review'));
        }
    }

    // ========== SAVE FUNCTIONS ==========

    function saveHeroSection() {
        const data = {
            tag: document.getElementById('heroTag').value,
            title: document.getElementById('heroTitle').value,
            text: document.getElementById('heroText').value,
            btn_text: document.getElementById('heroBtnText').value,
            btn_link: document.getElementById('heroBtnLink').value,
            image: document.getElementById('heroImage').value
        };
        
        database.ref('sections/hero').set(data)
            .then(() => {
                alert('Hero section saved successfully!');
            })
            .catch(err => {
                console.error(err);
                alert('Error saving hero section');
            });
    }

    function saveBanners() {
        const data = {
            left: {
                tag: document.getElementById('leftBannerTag').value,
                title: document.getElementById('leftBannerTitle').value,
                text: document.getElementById('leftBannerText').value,
                image: document.getElementById('leftBannerImage').value
            },
            right: {
                tag: document.getElementById('rightBannerTag').value,
                title: document.getElementById('rightBannerTitle').value,
                text: document.getElementById('rightBannerText').value,
                image: document.getElementById('rightBannerImage').value
            }
        };
        
        database.ref('sections/banners').set(data)
            .then(() => alert('Banners saved successfully!'))
            .catch(err => alert('Error saving banners'));
    }

    function saveServices() {
        const data = {};
        for (let i = 1; i <= 4; i++) {
            data[`service_${i}`] = {
                icon: document.getElementById(`service${i}Icon`).value,
                title: document.getElementById(`service${i}Title`).value,
                desc: document.getElementById(`service${i}Desc`).value
            };
        }
        
        database.ref('sections/services').set(data)
            .then(() => alert('Services saved successfully!'))
            .catch(err => alert('Error saving services'));
    }

    function saveTrustBadges() {
        const data = {};
        for (let i = 1; i <= 4; i++) {
            data[`trust_${i}`] = {
                icon: document.getElementById(`trust${i}Icon`).value,
                text: document.getElementById(`trust${i}Text`).value
            };
        }
        
        database.ref('sections/trust').set(data)
            .then(() => alert('Trust badges saved successfully!'))
            .catch(err => alert('Error saving trust badges'));
    }

    function saveFooter() {
        const data = {
            about_text: document.getElementById('footerAbout').value,
            social: {
                facebook: document.getElementById('socialFb').value,
                instagram: document.getElementById('socialIg').value,
                whatsapp: document.getElementById('socialWa').value,
                linkedin: document.getElementById('socialLi').value,
                youtube: document.getElementById('socialYt').value
            },
            contact: {
                address: document.getElementById('contactAddress').value,
                phone: document.getElementById('contactPhone').value,
                email: document.getElementById('contactEmail').value,
                hours: document.getElementById('contactHours').value
            },
            copyright: document.getElementById('copyrightText').value
        };
        
        database.ref('sections/footer').set(data)
            .then(() => alert('Footer saved successfully!'))
            .catch(err => alert('Error saving footer'));
    }

    // Live preview for hero
    function updateHeroPreview() {
        document.getElementById('previewTag').innerText = document.getElementById('heroTag').value || 'CHINA TO BANGLADESH';
        document.getElementById('previewTitle').innerHTML = document.getElementById('heroTitle').value || 'Global<br>Wholesale';
        document.getElementById('previewText').innerText = document.getElementById('heroText').value || 'Premium sourcing with door-to-door shipping';
        document.getElementById('previewBtn').innerText = document.getElementById('heroBtnText').value || 'SHOP NOW';
    }

    // Add event listeners for preview
    document.getElementById('heroTag')?.addEventListener('input', updateHeroPreview);
    document.getElementById('heroTitle')?.addEventListener('input', updateHeroPreview);
    document.getElementById('heroText')?.addEventListener('input', updateHeroPreview);
    document.getElementById('heroBtnText')?.addEventListener('input', updateHeroPreview);

    // ========== CATEGORIES ==========
    document.getElementById('saveCatBtn').onclick = async () => {
        const name = document.getElementById('catName').value.trim();
        if(name) { 
            await database.ref('categories').push({ name }); 
            document.getElementById('catName').value = ""; 
        }
    };

    function loadCategories() {
        database.ref('categories').on('value', snapshot => {
            const select = document.getElementById('pCatSel');
            const list = document.getElementById('catList');
            select.innerHTML = '<option value="">Select Category</option>';
            list.innerHTML = "";
            allCategories = [];
            
            snapshot.forEach(child => {
                const category = child.val();
                const catName = category.name || category;
                allCategories.push({ id: child.key, name: catName });
                select.innerHTML += `<option value="${catName}">${catName}</option>`;
                list.innerHTML += `<span class="badge bg-dark p-2">${catName} <i class="fa fa-times ms-2" style="cursor:pointer" onclick="deleteCategory('${child.key}')"></i></span>`;
            });
        });
    }

    window.deleteCategory = (id) => {
        if(confirm('Delete this category?')) {
            database.ref('categories/'+id).remove();
        }
    };

    // ========== PRODUCTS ==========
    document.getElementById('savePBtn').onclick = async () => {
        const btn = document.getElementById('savePBtn');
        const name = document.getElementById('pName').value.trim();
        const sku = document.getElementById('pSku').value.trim();
        const price = document.getElementById('pPrice').value;
        const category = document.getElementById('pCatSel').value;
        const mainImgFile = document.getElementById('pImg').files[0];
        
        if(!name || !mainImgFile || !price) {
            alert("Please fill all required fields!");
            return;
        }
        
        btn.disabled = true; 
        btn.innerText = "Publishing...";
        
        // Create variations object with images
        const variationsData = {};
        variations.forEach((v, idx) => {
            if (v.name && v.value) {
                variationsData[`var_${idx}`] = {
                    name: v.name,
                    value: v.value,
                    price: v.price || price,
                    image: v.image || null
                };
            }
        });
        
        const productData = {
            name: name,
            title: name,
            sku: sku,
            price: parseFloat(price),
            category: category,
            description: quill.root.innerHTML,
            image: await toBase64(mainImgFile),
            images: [await toBase64(mainImgFile), ...galleryArr],
            variations: Object.keys(variationsData).length > 0 ? variationsData : null,
            created_at: new Date().toISOString()
        };
        
        try {
            await database.ref('products').push(productData);
            alert("Product published successfully!");
            location.reload();
        } catch (error) {
            alert("Error: " + error.message);
            btn.disabled = false;
            btn.innerText = "PUBLISH PRODUCT";
        }
    };

    function loadProducts() {
        database.ref('products').on('value', snapshot => {
            const list = document.getElementById('pList');
            const totalElement = document.getElementById('totalProducts');
            list.innerHTML = "";
            let count = 0;
            allProducts = [];
            
            snapshot.forEach(child => {
                count++;
                const product = child.val();
                const productName = product.name || product.title || 'No Name';
                const productImg = product.image || (product.images ? product.images[0] : 'https://via.placeholder.com/50');
                const variationsCount = product.variations ? Object.keys(product.variations).length : 0;
                
                allProducts.push({ id: child.key, name: productName, category: product.category });
                
                list.innerHTML += `
                    <tr>
                        <td><img src="${productImg}" class="product-img" onerror="this.src='https://via.placeholder.com/50'"></td>
                        <td>
                            <strong>${productName}</strong><br>
                            <small class="text-muted">${child.key}</small>
                        </td>
                        <td>${product.sku || '-'}</td>
                        <td>৳${product.price || '0'}</td>
                        <td>${variationsCount} variations</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${child.key}')">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            if (totalElement) totalElement.innerText = count;
            if (document.getElementById('analyticsProducts')) {
                document.getElementById('analyticsProducts').innerText = count;
            }
        });
    }

    window.deleteProduct = (id) => {
        if(confirm("Delete this product?")) {
            database.ref('products/'+id).remove();
        }
    };

    // ========== COUPON FUNCTIONS ==========
    function toggleDiscountFields() {
        const type = document.getElementById('discountType').value;
        const maxDiscountField = document.getElementById('maxDiscountAmount').parentElement;
        if (type === 'percentage') {
            maxDiscountField.style.display = 'block';
        } else {
            maxDiscountField.style.display = 'none';
        }
    }

    function loadProductsForCoupon() {
        const select = document.getElementById('excludeProducts');
        select.innerHTML = '';
        allProducts.forEach(product => {
            select.innerHTML += `<option value="${product.id}">${product.name}</option>`;
        });
    }

    function loadCategoriesForCoupon() {
        const select = document.getElementById('excludeCategories');
        select.innerHTML = '';
        allCategories.forEach(cat => {
            select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
        });
    }

    window.createCoupon = async () => {
        const code = document.getElementById('couponCode').value.trim().toUpperCase();
        const type = document.getElementById('discountType').value;
        const value = parseFloat(document.getElementById('discountValue').value);
        const validFrom = document.getElementById('validFrom').value;
        const validUntil = document.getElementById('validUntil').value;
        const usageLimit = parseInt(document.getElementById('usageLimit').value) || 0;
        const minOrderAmount = parseFloat(document.getElementById('minOrderAmount').value) || 0;
        const maxDiscountAmount = parseFloat(document.getElementById('maxDiscountAmount').value) || 0;
        const description = document.getElementById('couponDescription').value.trim();
        
        // Get excluded items
        const excludeProducts = Array.from(document.getElementById('excludeProducts').selectedOptions).map(opt => opt.value);
        const excludeCategories = Array.from(document.getElementById('excludeCategories').selectedOptions).map(opt => opt.value);
        
        if (!code || !value) {
            alert('Please enter coupon code and discount value');
            return;
        }
        
        if (type === 'percentage' && value > 100) {
            alert('Percentage discount cannot exceed 100%');
            return;
        }
        
        const couponData = {
            code: code,
            type: type,
            value: value,
            valid_from: validFrom || null,
            valid_until: validUntil || null,
            usage_limit: usageLimit,
            usage_count: 0,
            min_order_amount: minOrderAmount,
            max_discount_amount: maxDiscountAmount,
            exclude_products: excludeProducts,
            exclude_categories: excludeCategories,
            description: description,
            status: 'active',
            created_at: new Date().toISOString()
        };
        
        try {
            await database.ref('coupons').push(couponData);
            alert('Coupon created successfully!');
            clearCouponForm();
            loadCoupons();
        } catch (error) {
            console.error('Error creating coupon:', error);
            alert('Failed to create coupon');
        }
    };

    function clearCouponForm() {
        document.getElementById('couponCode').value = '';
        document.getElementById('discountValue').value = '';
        document.getElementById('validFrom').value = '';
        document.getElementById('validUntil').value = '';
        document.getElementById('usageLimit').value = '0';
        document.getElementById('minOrderAmount').value = '0';
        document.getElementById('maxDiscountAmount').value = '0';
        document.getElementById('couponDescription').value = '';
        document.getElementById('excludeProducts').selectedIndex = -1;
        document.getElementById('excludeCategories').selectedIndex = -1;
    }

    function loadCoupons() {
        database.ref('coupons').on('value', snapshot => {
            const list = document.getElementById('couponsList');
            list.innerHTML = '';
            let activeCount = 0;
            const now = new Date();
            
            snapshot.forEach(child => {
                const coupon = child.val();
                const validFrom = coupon.valid_from ? new Date(coupon.valid_from) : null;
                const validUntil = coupon.valid_until ? new Date(coupon.valid_until) : null;
                
                let status = 'active';
                let statusClass = 'status-active';
                
                if (validUntil && validUntil < now) {
                    status = 'expired';
                    statusClass = 'status-expired';
                } else if (coupon.usage_limit > 0 && coupon.usage_count >= coupon.usage_limit) {
                    status = 'used up';
                    statusClass = 'status-expired';
                }
                
                if (status === 'active') activeCount++;
                
                const discountText = coupon.type === 'fixed' 
                    ? `৳ ${coupon.value}` 
                    : `${coupon.value}% ${coupon.max_discount_amount > 0 ? `(Max ৳${coupon.max_discount_amount})` : ''}`;
                
                list.innerHTML += `
                    <tr>
                        <td><strong>${coupon.code}</strong></td>
                        <td>${discountText}</td>
                        <td>${coupon.valid_from ? new Date(coupon.valid_from).toLocaleDateString() : 'Unlimited'}</td>
                        <td>${coupon.valid_until ? new Date(coupon.valid_until).toLocaleDateString() : 'Unlimited'}</td>
                        <td>${coupon.usage_count || 0}/${coupon.usage_limit || '∞'}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCoupon('${child.key}')">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            if (document.getElementById('activeCoupons')) {
                document.getElementById('activeCoupons').innerText = activeCount;
            }
        });
    }

    window.deleteCoupon = (id) => {
        if(confirm('Delete this coupon?')) {
            database.ref('coupons/'+id).remove();
        }
    };

    // ========== ORDER STATUS ==========
    const statusOptions = [
        { value: 'pending', label: '⏳ Pending', class: 'status-pending' },
        { value: 'placed', label: '📦 Order Placed', class: 'status-placed' },
        { value: 'processing', label: '⚙️ Processing', class: 'status-processing' },
        { value: 'shipping', label: '🚚 Shipping', class: 'status-shipping' },
        { value: 'completed', label: '✅ Completed', class: 'status-completed' },
        { value: 'cancelled', label: '❌ Cancelled', class: 'status-cancelled' }
    ];

    function getStatusBadge(status) {
        const option = statusOptions.find(opt => opt.value === status) || statusOptions[0];
        return `<span class="status-badge ${option.class}">${option.label}</span>`;
    }

    function getPaymentTypeBadge(method) {
        if (method === 'cod_advance') {
            return '<span class="payment-type-badge payment-type-advance"><i class="fas fa-clock"></i> COD Advance</span>';
        } else if (method === 'full_payment') {
            return '<span class="payment-type-badge payment-type-full"><i class="fas fa-check-circle"></i> Full Payment</span>';
        }
        return '<span class="payment-type-badge">Unknown</span>';
    }

    window.updateOrderStatus = async (orderId, newStatus) => {
        try {
            const orderRef = database.ref('orders/' + orderId);
            const snapshot = await orderRef.once('value');
            const order = snapshot.val();

            const statusHistory = order.status_history || [];
            statusHistory.push({
                status: newStatus,
                timestamp: new Date().toISOString(),
                note: `Status updated to ${newStatus} by admin`
            });

            await orderRef.update({
                status: newStatus,
                updated_at: new Date().toISOString(),
                status_history: statusHistory
            });

            alert('Order status updated successfully!');
            
            if (document.getElementById('payment-verification').style.display !== 'none') {
                loadPaymentVerification();
            } else if (document.getElementById('orders').style.display !== 'none') {
                loadOrders(currentFilter);
            }
            loadAnalytics();
            loadDashboard();
            
        } catch (error) {
            console.error('Error updating status:', error);
            alert('Failed to update status');
        }
    };

    window.deleteOrder = async (orderId) => {
        if(confirm("Are you sure you want to delete this order?")) {
            try {
                await database.ref('orders/' + orderId).remove();
                alert("Order deleted successfully!");
                loadOrders(currentFilter);
                loadAnalytics();
                loadDashboard();
            } catch (error) {
                console.error('Error deleting order:', error);
                alert("Failed to delete order");
            }
        }
    };

    // ========== PAYMENT VERIFICATION ==========
    window.verifyPayment = async (orderId) => {
        try {
            const orderRef = database.ref('orders/' + orderId);
            const snapshot = await orderRef.once('value');
            const order = snapshot.val();

            const statusHistory = order.status_history || [];
            let statusNote = '';
            
            if (order.payment.method === 'cod_advance') {
                statusNote = `Advance payment verified (৳${order.payment.amount_paid}). Order placed with China supplier.`;
            } else {
                statusNote = `Full payment verified (৳${order.payment.amount_paid}). Order placed with China supplier.`;
            }
            
            statusHistory.push({
                status: 'placed',
                timestamp: new Date().toISOString(),
                note: statusNote
            });

            await orderRef.update({
                'payment.status': 'paid',
                'payment.verified_at': new Date().toISOString(),
                'payment.verified_by': 'admin',
                status: 'placed',
                updated_at: new Date().toISOString(),
                status_history: statusHistory
            });

            alert('Payment verified! Order status set to "Order Placed"');
            loadPaymentVerification();
            loadAnalytics();
            loadDashboard();
            
        } catch (error) {
            console.error('Error verifying payment:', error);
            alert('Failed to verify payment');
        }
    };

    function loadPaymentVerification() {
        database.ref('orders').once('value', (snapshot) => {
            const list = document.getElementById('paymentVerificationList');
            list.innerHTML = '';
            let pendingCount = 0;

            snapshot.forEach(child => {
                const order = child.val();
                const payment = order.payment || {};
                
                // Only show orders that need verification (pending status)
                if (payment.status === 'pending') {
                    pendingCount++;
                    
                    // Apply filter
                    if (currentPaymentFilter !== 'all' && payment.method !== currentPaymentFilter) {
                        return;
                    }
                    
                    list.innerHTML += `
                        <tr>
                            <td><strong>${child.key}</strong></td>
                            <td>
                                ${order.customer?.name || 'N/A'}<br>
                                <small class="text-muted">${order.customer?.phone || ''}</small>
                            </td>
                            <td>৳ ${order.total?.toFixed(0) || '0'}</td>
                            <td>${getPaymentTypeBadge(payment.method)}</td>
                            <td><strong>৳ ${payment.amount_paid?.toFixed(0) || '0'}</strong></td>
                            <td>
                                <span class="status-badge status-pending">
                                    <i class="fas fa-clock"></i> Awaiting
                                </span>
                            </td>
                            <td>
                                <button class="verify-btn" onclick="verifyPayment('${child.key}')">
                                    <i class="fas fa-check"></i> Verify
                                </button>
                            </td>
                        </tr>
                    `;
                }
            });

            if (pendingCount === 0) {
                list.innerHTML = '<tr><td colspan="7" class="text-center py-4">No pending verifications</td></tr>';
            }

            if (document.getElementById('pendingPaymentCount')) {
                document.getElementById('pendingPaymentCount').innerText = pendingCount;
            }
            if (document.getElementById('pendingVerificationCount')) {
                document.getElementById('pendingVerificationCount').innerText = pendingCount;
            }
        });
    }

    // ========== ORDERS ==========
    window.filterOrders = (status, btn) => {
        currentFilter = status;
        loadOrders(status);
        
        document.querySelectorAll('#orders .filter-btn').forEach(b => {
            b.classList.remove('active');
        });
        btn.classList.add('active');
    };

    function loadOrders(statusFilter = 'all') {
        database.ref('orders').once('value', (snapshot) => {
            const list = document.getElementById('orderList');
            list.innerHTML = '';

            snapshot.forEach(child => {
                const order = child.val();
                
                if (statusFilter === 'all' || order.status === statusFilter) {
                    const payment = order.payment || {};
                    const paymentMethod = payment.method || 'cod_advance';
                    const paidAmount = payment.amount_paid || 0;
                    const dueAmount = order.total - paidAmount;
                    const couponApplied = order.coupon ? `<span class="coupon-badge">${order.coupon.code}</span>` : '-';
                    
                    list.innerHTML += `
                        <tr>
                            <td><strong>${child.key}</strong></td>
                            <td>
                                ${order.customer?.name || 'N/A'}<br>
                                <small class="text-muted">${order.customer?.phone || ''}</small>
                            </td>
                            <td>৳ ${order.total?.toFixed(0) || '0'}</td>
                            <td>${getPaymentTypeBadge(paymentMethod)}</td>
                            <td><span class="text-success">৳ ${paidAmount.toFixed(0)}</span></td>
                            <td><span class="text-warning">৳ ${dueAmount.toFixed(0)}</span></td>
                            <td>${couponApplied}</td>
                            <td>${getStatusBadge(order.status || 'pending')}</td>
                            <td>${new Date(order.created_at).toLocaleDateString()}</td>
                            <td>
                                <select class="form-select form-select-sm mb-1" onchange="updateOrderStatus('${child.key}', this.value)">
                                    ${statusOptions.map(opt => `
                                        <option value="${opt.value}" ${order.status === opt.value ? 'selected' : ''}>
                                            ${opt.label}
                                        </option>
                                    `).join('')}
                                </select>
                                <button class="btn btn-sm btn-outline-danger mt-1" onclick="deleteOrder('${child.key}')">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }
            });
        });
    }

    // ========== PAYMENT FILTER ==========
    window.filterPayments = (method, btn) => {
        currentPaymentFilter = method;
        loadPaymentVerification();
        
        document.querySelectorAll('#payment-verification .filter-btn').forEach(b => {
            b.classList.remove('active');
        });
        btn.classList.add('active');
    };

    // ========== DASHBOARD ==========
    function loadDashboard() {
        database.ref('orders').once('value', (snapshot) => {
            let totalOrders = 0;
            let pendingVerification = 0;
            let completedCount = 0;
            let totalRevenue = 0;
            let todayOrders = 0;
            let recentOrders = [];
            const today = new Date().toDateString();

            snapshot.forEach(child => {
                totalOrders++;
                const order = child.val();
                
                if (order.payment?.status === 'pending') pendingVerification++;
                if (order.status === 'completed') {
                    completedCount++;
                    totalRevenue += order.total || 0;
                }
                
                if (new Date(order.created_at).toDateString() === today) {
                    todayOrders++;
                }
                
                if (recentOrders.length < 5) {
                    recentOrders.push({ id: child.key, ...order });
                }
            });

            document.getElementById('totalOrders').innerText = totalOrders;
            document.getElementById('pendingVerificationCount').innerText = pendingVerification;
            document.getElementById('completedCount').innerText = completedCount;
            document.getElementById('totalRevenue').innerText = `৳${totalRevenue.toFixed(0)}`;
            document.getElementById('todayOrders').innerText = todayOrders;
            document.getElementById('avgOrderValue').innerText = totalOrders > 0 ? `৳${(totalRevenue/totalOrders).toFixed(0)}` : '৳0';

            const recentList = document.getElementById('recentOrdersList');
            recentList.innerHTML = '';
            recentOrders.forEach(order => {
                const paidAmount = order.payment?.amount_paid || 0;
                recentList.innerHTML += `
                    <tr>
                        <td>${order.id}</td>
                        <td>${order.customer?.name || 'N/A'}</td>
                        <td>৳ ${order.total?.toFixed(0) || '0'}</td>
                        <td>${getPaymentTypeBadge(order.payment?.method)}</td>
                        <td>৳ ${paidAmount.toFixed(0)}</td>
                        <td>${getStatusBadge(order.status || 'pending')}</td>
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                    </tr>
                `;
            });
        });
        
        // Load products count
        database.ref('products').once('value', (snapshot) => {
            document.getElementById('totalProducts').innerText = snapshot.numChildren();
        });
        
        // Load coupons count
        database.ref('coupons').once('value', (snapshot) => {
            let activeCount = 0;
            const now = new Date();
            snapshot.forEach((child) => {
                const coupon = child.val();
                const validUntil = coupon.valid_until ? new Date(coupon.valid_until) : null;
                if (coupon.status === 'active' && (!validUntil || validUntil > now)) {
                    activeCount++;
                }
            });
            document.getElementById('activeCoupons').innerText = activeCount;
        });
    }

    // ========== ANALYTICS ==========
    function loadAnalytics() {
        database.ref('orders').once('value', (snapshot) => {
            let totalRevenue = 0;
            let totalOrders = 0;
            let paymentMethods = { cod_advance: 0, full_payment: 0 };
            let orderStatus = { pending: 0, placed: 0, processing: 0, shipping: 0, completed: 0, cancelled: 0 };
            let productSales = {};
            let couponUsageCount = 0;

            snapshot.forEach(child => {
                totalOrders++;
                const order = child.val();
                
                if (order.status === 'completed') {
                    totalRevenue += order.total || 0;
                }
                
                const method = order.payment?.method || 'cod_advance';
                paymentMethods[method] = (paymentMethods[method] || 0) + 1;
                
                if (order.coupon) {
                    couponUsageCount++;
                }
                
                const status = order.status || 'pending';
                orderStatus[status] = (orderStatus[status] || 0) + 1;
                
                if (order.items) {
                    order.items.forEach(item => {
                        const productName = item.name;
                        productSales[productName] = (productSales[productName] || 0) + item.quantity;
                    });
                }
            });

            document.getElementById('analyticsRevenue').innerHTML = `৳${totalRevenue.toFixed(0)}`;
            document.getElementById('analyticsOrders').innerText = totalOrders;
            document.getElementById('couponUsageCount').innerText = couponUsageCount;

            // Payment Methods Stats
            const paymentStats = document.getElementById('paymentStats');
            paymentStats.innerHTML = `
                <div class="d-flex justify-content-between mb-1">
                    <span>COD Advance (30%):</span> <strong>${paymentMethods.cod_advance || 0}</strong>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>Full Payment:</span> <strong>${paymentMethods.full_payment || 0}</strong>
                </div>
            `;

            // Status Stats
            const statusStats = document.getElementById('statusStats');
            statusStats.innerHTML = `
                <div class="d-flex justify-content-between mb-1">
                    <span>⏳ Pending:</span> <strong>${orderStatus.pending || 0}</strong>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>📦 Placed:</span> <strong>${orderStatus.placed || 0}</strong>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>⚙️ Processing:</span> <strong>${orderStatus.processing || 0}</strong>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>🚚 Shipping:</span> <strong>${orderStatus.shipping || 0}</strong>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>✅ Completed:</span> <strong>${orderStatus.completed || 0}</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>❌ Cancelled:</span> <strong>${orderStatus.cancelled || 0}</strong>
                </div>
            `;

            // Top Products
            const topProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const topProductsList = document.getElementById('topProductsList');
            topProductsList.innerHTML = topProducts.length > 0 
                ? topProducts.map(([name, qty]) => `
                    <div class="d-flex justify-content-between mb-2">
                        <span>${name}</span>
                        <strong>${qty} sold</strong>
                    </div>
                `).join('')
                : '<p class="text-muted">No sales data yet</p>';

            // Charts
            if (ordersChart) ordersChart.destroy();
            if (revenueChart) revenueChart.destroy();
            if (paymentChart) paymentChart.destroy();
            if (statusChart) statusChart.destroy();

            ordersChart = new Chart(document.getElementById('ordersChart'), {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Orders',
                        data: [12, 19, 15, 25, 22, 30],
                        borderColor: '#ff385c',
                        tension: 0.4
                    }]
                },
                options: { responsive: true }
            });

            revenueChart = new Chart(document.getElementById('revenueChart'), {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Revenue (৳)',
                        data: [15000, 22000, 18000, 28000, 25000, 35000],
                        backgroundColor: '#ff385c'
                    }]
                },
                options: { responsive: true }
            });

            paymentChart = new Chart(document.getElementById('paymentChart'), {
                type: 'doughnut',
                data: {
                    labels: ['COD Advance (30%)', 'Full Payment'],
                    datasets: [{
                        data: [paymentMethods.cod_advance || 1, paymentMethods.full_payment || 1],
                        backgroundColor: ['#ffc107', '#28a745']
                    }]
                },
                options: { responsive: true }
            });

            statusChart = new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Placed', 'Processing', 'Shipping', 'Completed', 'Cancelled'],
                    datasets: [{
                        data: [
                            orderStatus.pending || 1,
                            orderStatus.placed || 1,
                            orderStatus.processing || 1,
                            orderStatus.shipping || 1,
                            orderStatus.completed || 1,
                            orderStatus.cancelled || 1
                        ],
                        backgroundColor: ['#ffc107', '#28a745', '#17a2b8', '#007bff', '#28a745', '#dc3545']
                    }]
                },
                options: { responsive: true }
            });
        });
    }

    // Initialize
    function init() {
        loadDashboard();
        // Default to dashboard
        showSection('dashboard', document.querySelector('.nav-link.active'));
    }

    init();
</script>
</body>
                        </html>
