<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin | Espera Mavro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --dark: #111; 
            --bg: #f8f9fa;
            --primary: #000000;
            --accent: #ff385c;
            --success: #2e7d32;
            --warning: #ed6c02;
            --info: #0288d1;
            --danger: #d32f2f;
        }
        
        body { background: var(--bg); font-family: 'Inter', sans-serif; }
        
        .sidebar { 
            background: #fff; 
            height: 100vh; 
            position: fixed; 
            width: 280px; 
            border-right: 1px solid #ddd; 
            padding: 25px; 
            z-index: 100; 
            overflow-y: auto; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.02);
        }
        
        .main { 
            margin-left: 280px; 
            padding: 30px; 
        }
        
        @media (max-width: 768px) { 
            .sidebar { 
                height: auto; 
                width: 100%; 
                position: relative; 
            } 
            .main { 
                margin-left: 0; 
                padding: 15px; 
            } 
        }
        
        .card-custom { 
            background: #fff; 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); 
            margin-bottom: 25px; 
            border: 1px solid #eee; 
        }
        
        .nav-link { 
            color: #333; 
            padding: 12px 15px; 
            border-radius: 12px; 
            margin-bottom: 5px; 
            cursor: pointer; 
            text-decoration: none; 
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
        }
        
        .nav-link:hover { 
            background: #f5f5f5; 
        }
        
        .nav-link.active { 
            background: var(--primary); 
            color: #fff; 
        }
        
        .nav-link i { 
            width: 24px; 
            font-size: 18px; 
        }

        .product-img { 
            width: 50px; 
            height: 65px; 
            object-fit: cover; 
            border-radius: 8px; 
            background: #eee; 
        }

        .gallery-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-top: 15px; 
        }

        .gallery-item { 
            position: relative; 
            width: 70px; 
            height: 70px; 
        }

        .gallery-item img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            border-radius: 8px; 
            border: 1px solid #ddd; 
        }

        .remove-btn { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            background: #ff4d4d; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 22px; 
            height: 22px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
        }

        .upload-trigger { 
            border: 2px dashed #000; 
            padding: 15px; 
            border-radius: 10px; 
            text-align: center; 
            cursor: pointer; 
            background: #fff; 
            font-weight: bold; 
        }

        #editor { 
            height: 300px; 
            background: white; 
        }
        
        .variation-row { 
            background: #f9f9f9; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            border: 1px solid #eee;
        }
        
        .status-badge { 
            padding: 6px 12px; 
            border-radius: 50px; 
            font-size: 12px; 
            font-weight: 600; 
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-pending { background: #fff3cd; color: #856404; }
        .status-placed { background: #d4edda; color: #155724; }
        .status-processing { background: #cce5ff; color: #004085; }
        .status-shipping { background: #d1ecf1; color: #0c5460; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .status-awaiting_verification { background: #fff3cd; color: #856404; border-left: 3px solid var(--warning); }
        
        .payment-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
        }
        
        .payment-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
        }
        
        .payment-detail:last-child {
            border-bottom: none;
        }
        
        .verify-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .verify-btn:hover { background: #1e5622; }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border-radius: 30px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            transition: 0.2s;
            font-size: 13px;
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .stat-card h3 { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .stat-card p { opacity: 0.9; margin-bottom: 0; }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }

        .delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .delete-btn:hover { background: #b71c1c; }

        .variant-image-preview {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <h4 class="mb-4 fw-bold text-center">ESPERA <span style="color: var(--accent);">MAVRO</span></h4>
    <p class="text-center small text-muted mb-4">Master Admin Panel</p>
    
    <nav class="nav flex-column">
        <a class="nav-link active" onclick="showSection('dashboard', this)">
            <i class="fa fa-dashboard"></i> Dashboard
        </a>
        <a class="nav-link" onclick="showSection('analytics', this)">
            <i class="fa fa-chart-line"></i> Analytics
        </a>
        <a class="nav-link" onclick="showSection('products', this)">
            <i class="fa fa-box"></i> Products
        </a>
        <a class="nav-link" onclick="showSection('categories', this)">
            <i class="fa fa-list"></i> Categories
        </a>
        <a class="nav-link" onclick="showSection('orders', this)">
            <i class="fa fa-shopping-cart"></i> Orders
        </a>
        <a class="nav-link" onclick="showSection('payment-verification', this)">
            <i class="fa fa-check-circle"></i> Payment Verification
            <span class="badge bg-danger ms-auto" id="pendingPaymentCount">0</span>
        </a>
    </nav>
</div>

<div class="main">
    <!-- Dashboard -->
    <div id="dashboard" class="section">
        <h3 class="mb-4">Dashboard Overview</h3>
        <div class="row g-4">
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Total Products</h6>
                    <h2 id="totalProducts">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Total Orders</h6>
                    <h2 id="totalOrders">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Pending Verification</h6>
                    <h2 id="pendingVerificationCount">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Processing Orders</h6>
                    <h2 id="processingCount">0</h2>
                </div>
            </div>
        </div>
        
        <div class="row g-4 mt-2">
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Completed Orders</h6>
                    <h2 id="completedCount">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Total Revenue</h6>
                    <h2 id="totalRevenue">‡ß≥0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Today's Orders</h6>
                    <h2 id="todayOrders">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Avg Order Value</h6>
                    <h2 id="avgOrderValue">‡ß≥0</h2>
                </div>
            </div>
        </div>
        
        <div class="card-custom mt-4">
            <h5>Recent Orders</h5>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Payment</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="recentOrdersList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Analytics Section -->
    <div id="analytics" class="section" style="display: none;">
        <h3 class="mb-4">Analytics Dashboard</h3>
        
        <div class="row g-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <p>Total Revenue</p>
                    <h3 id="analyticsRevenue">‡ß≥0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <p>Total Orders</p>
                    <h3 id="analyticsOrders">0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <p>Total Products</p>
                    <h3 id="analyticsProducts">0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <p>Conversion Rate</p>
                    <h3 id="conversionRate">0%</h3>
                </div>
            </div>
        </div>

        <div class="row g-4 mt-2">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="ordersChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row g-4 mt-2">
            <div class="col-md-4">
                <div class="card-custom">
                    <h5>Payment Methods</h5>
                    <canvas id="paymentChart" style="height: 200px;"></canvas>
                    <div class="mt-3" id="paymentStats"></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-custom">
                    <h5>Order Status</h5>
                    <canvas id="statusChart" style="height: 200px;"></canvas>
                    <div class="mt-3" id="statusStats"></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-custom">
                    <h5>Top Products</h5>
                    <div id="topProductsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Section -->
    <div id="products" class="section" style="display: none;">
        <div class="card-custom">
            <h5 class="mb-4 fw-bold">Publish New Product</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="small fw-bold">Product Name *</label>
                    <input type="text" id="pName" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold">SKU *</label>
                    <input type="text" id="pSku" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold">Price (‡ß≥) *</label>
                    <input type="number" id="pPrice" class="form-control">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Category</label>
                    <select id="pCatSel" class="form-select">
                        <option value="">Select Category</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Main Image *</label>
                    <input type="file" id="pImg" class="form-control" accept="image/*">
                </div>
                <div class="col-12">
                    <label class="small fw-bold">Gallery Images</label>
                    <div class="upload-trigger" onclick="document.getElementById('galleryInput').click()">+ Add Gallery Images</div>
                    <input type="file" id="galleryInput" class="d-none" multiple accept="image/*">
                    <div id="galleryContainer" class="gallery-container"></div>
                </div>
                <div class="col-12">
                    <h5>Variations</h5>
                    <button class="btn btn-sm btn-outline-dark mb-2" onclick="addVariation()">+ Add Variation</button>
                    <div id="variationsContainer"></div>
                </div>
                <div class="col-12">
                    <label class="small fw-bold">Description</label>
                    <div id="editor"></div>
                </div>
                <div class="col-12">
                    <button id="savePBtn" class="btn btn-dark w-100 py-3 mt-3 fw-bold">PUBLISH PRODUCT</button>
                </div>
            </div>
        </div>

        <div class="card-custom">
            <h5>Live Inventory</h5>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Price</th>
                            <th>Variations</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="pList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Categories Section -->
    <div id="categories" class="section" style="display: none;">
        <div class="card-custom">
            <h5>Manage Categories</h5>
            <div class="input-group mb-3">
                <input type="text" id="catName" class="form-control" placeholder="Category Name">
                <button id="saveCatBtn" class="btn btn-dark">Add Category</button>
            </div>
            <div id="catList" class="d-flex flex-wrap gap-2"></div>
        </div>
    </div>

    <!-- Payment Verification Section -->
    <div id="payment-verification" class="section" style="display: none;">
        <h3 class="mb-4">Payment Verification</h3>
        
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterPayments('all', this)">All</button>
            <button class="filter-btn" onclick="filterPayments('bkash', this)">bKash</button>
            <button class="filter-btn" onclick="filterPayments('nagad', this)">Nagad</button>
        </div>
        
        <div class="card-custom">
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Payment Method</th>
                            <th>Transaction ID</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="paymentVerificationList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Orders Section -->
    <div id="orders" class="section" style="display: none;">
        <h3 class="mb-4">Order Management</h3>
        
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterOrders('all', this)">All</button>
            <button class="filter-btn" onclick="filterOrders('pending', this)">Pending</button>
            <button class="filter-btn" onclick="filterOrders('placed', this)">Order Placed</button>
            <button class="filter-btn" onclick="filterOrders('processing', this)">Processing</button>
            <button class="filter-btn" onclick="filterOrders('shipping', this)">Shipping</button>
            <button class="filter-btn" onclick="filterOrders('completed', this)">Completed</button>
            <button class="filter-btn" onclick="filterOrders('cancelled', this)">Cancelled</button>
        </div>
        
        <div class="card-custom">
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Payment</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="orderList"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAB7dyaJwkadV7asGOhj6TCN5it5pCWg10",
        authDomain: "espera-mavro-6ddc5.firebaseapp.com",
        databaseURL: "https://espera-mavro-6ddc5-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "espera-mavro-6ddc5",
        storageBucket: "espera-mavro-6ddc5.appspot.com",
        messagingSenderId: "137893255543",
        appId: "1:137893255543:web:a660bd412eb26ee322a972"
    };
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Initialize Quill
    const quill = new Quill('#editor', { theme: 'snow' });
    
    // State
    let galleryArr = [];
    let variations = [];
    let currentFilter = 'all';
    let ordersChart, revenueChart, paymentChart, statusChart;

    // Navigation
    window.showSection = (id, el) => {
        document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        el.classList.add('active');
        
        if (id === 'products') loadProducts();
        if (id === 'categories') loadCategories();
        if (id === 'payment-verification') loadPaymentVerification();
        if (id === 'orders') loadOrders('all');
        if (id === 'analytics') loadAnalytics();
        if (id === 'dashboard') loadDashboard();
    };

    // ========== IMAGE HANDLING ==========
    const toBase64 = f => new Promise((resolve) => {
        const reader = new FileReader(); 
        reader.readAsDataURL(f); 
        reader.onload = () => resolve(reader.result);
    });

    document.getElementById('galleryInput').onchange = async (e) => {
        for(let file of e.target.files) { 
            galleryArr.push(await toBase64(file)); 
        }
        renderGallery();
    };

    function renderGallery() {
        const container = document.getElementById('galleryContainer');
        container.innerHTML = galleryArr.map((src, index) => `
            <div class="gallery-item">
                <img src="${src}">
                <button class="remove-btn" onclick="galleryArr.splice(${index},1);renderGallery()">√ó</button>
            </div>
        `).join('');
    }

    // ========== VARIATIONS (FIXED) ==========
    window.addVariation = () => {
        variations.push({ 
            name: '', 
            value: '', 
            price: '', 
            image: null,
            imagePreview: null 
        });
        renderVariations();
    };

    function renderVariations() {
        const container = document.getElementById('variationsContainer');
        container.innerHTML = variations.map((v, i) => `
            <div class="variation-row">
                <div class="row g-2">
                    <div class="col-md-3">
                        <input type="text" class="form-control" placeholder="Type (e.g., Color)" value="${v.name}" onchange="updateVariation(${i}, 'name', this.value)">
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" placeholder="Value (e.g., Red)" value="${v.value}" onchange="updateVariation(${i}, 'value', this.value)">
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" placeholder="Price" value="${v.price}" onchange="updateVariation(${i}, 'price', this.value)">
                    </div>
                    <div class="col-md-3">
                        <input type="file" class="form-control" accept="image/*" onchange="uploadVariationImage(${i}, this)">
                        ${v.imagePreview ? `<img src="${v.imagePreview}" class="variant-image-preview">` : ''}
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-outline-danger" onclick="removeVariation(${i})">√ó</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    window.updateVariation = (index, field, value) => {
        variations[index][field] = value;
    };

    window.uploadVariationImage = async (index, input) => {
        if (input.files && input.files[0]) {
            const base64 = await toBase64(input.files[0]);
            variations[index].image = base64;
            variations[index].imagePreview = base64;
            renderVariations();
        }
    };

    window.removeVariation = (index) => {
        variations.splice(index, 1);
        renderVariations();
    };

    // ========== CATEGORIES ==========
    document.getElementById('saveCatBtn').onclick = async () => {
        const name = document.getElementById('catName').value.trim();
        if(name) { 
            await database.ref('categories').push({ name }); 
            document.getElementById('catName').value = ""; 
        }
    };

    function loadCategories() {
        database.ref('categories').on('value', snapshot => {
            const select = document.getElementById('pCatSel');
            const list = document.getElementById('catList');
            select.innerHTML = '<option value="">Select Category</option>';
            list.innerHTML = "";
            
            snapshot.forEach(child => {
                const category = child.val();
                const catName = category.name || category;
                select.innerHTML += `<option value="${catName}">${catName}</option>`;
                list.innerHTML += `<span class="badge bg-dark p-2">${catName} <i class="fa fa-times ms-2" style="cursor:pointer" onclick="deleteCategory('${child.key}')"></i></span>`;
            });
        });
    }

    window.deleteCategory = (id) => {
        if(confirm('Delete this category?')) {
            database.ref('categories/'+id).remove();
        }
    };

    // ========== PRODUCTS (FIXED) ==========
    document.getElementById('savePBtn').onclick = async () => {
        const btn = document.getElementById('savePBtn');
        const name = document.getElementById('pName').value.trim();
        const sku = document.getElementById('pSku').value.trim();
        const price = document.getElementById('pPrice').value;
        const category = document.getElementById('pCatSel').value;
        const mainImgFile = document.getElementById('pImg').files[0];
        
        if(!name || !mainImgFile || !price) {
            alert("Please fill all required fields!");
            return;
        }
        
        btn.disabled = true; 
        btn.innerText = "Publishing...";
        
        // Create variations object with images
        const variationsData = {};
        variations.forEach((v, idx) => {
            if (v.name && v.value) {
                variationsData[`var_${idx}`] = {
                    name: v.name,
                    value: v.value,
                    price: v.price || price,
                    image: v.image || null
                };
            }
        });
        
        const productData = {
            name: name,
            title: name,
            sku: sku,
            price: parseFloat(price),
            category: category,
            description: quill.root.innerHTML,
            image: await toBase64(mainImgFile),
            images: [await toBase64(mainImgFile), ...galleryArr],
            variations: Object.keys(variationsData).length > 0 ? variationsData : null,
            created_at: new Date().toISOString()
        };
        
        try {
            await database.ref('products').push(productData);
            alert("Product published successfully!");
            location.reload();
        } catch (error) {
            alert("Error: " + error.message);
            btn.disabled = false;
            btn.innerText = "PUBLISH PRODUCT";
        }
    };

    function loadProducts() {
        database.ref('products').on('value', snapshot => {
            const list = document.getElementById('pList');
            const totalElement = document.getElementById('totalProducts');
            list.innerHTML = "";
            let count = 0;
            
            snapshot.forEach(child => {
                count++;
                const product = child.val();
                const productName = product.name || product.title || 'No Name';
                const productImg = product.image || (product.images ? product.images[0] : 'https://via.placeholder.com/50');
                const variationsCount = product.variations ? Object.keys(product.variations).length : 0;
                
                list.innerHTML += `
                    <tr>
                        <td><img src="${productImg}" class="product-img" onerror="this.src='https://via.placeholder.com/50'"></td>
                        <td>
                            <strong>${productName}</strong><br>
                            <small class="text-muted">${child.key}</small>
                        </td>
                        <td>${product.sku || '-'}</td>
                        <td>‡ß≥${product.price || '0'}</td>
                        <td>${variationsCount} variations</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${child.key}')">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            totalElement.innerText = count;
            document.getElementById('analyticsProducts').innerText = count;
        });
    }

    window.deleteProduct = (id) => {
        if(confirm("Delete this product?")) {
            database.ref('products/'+id).remove();
        }
    };

    // ========== ORDER STATUS ==========
    const statusOptions = [
        { value: 'pending', label: '‚è≥ Pending', class: 'status-pending' },
        { value: 'placed', label: 'üì¶ Order Placed', class: 'status-placed' },
        { value: 'processing', label: '‚öôÔ∏è Processing', class: 'status-processing' },
        { value: 'shipping', label: 'üöö Shipping', class: 'status-shipping' },
        { value: 'completed', label: '‚úÖ Completed', class: 'status-completed' },
        { value: 'cancelled', label: '‚ùå Cancelled', class: 'status-cancelled' }
    ];

    function getStatusBadge(status) {
        const option = statusOptions.find(opt => opt.value === status) || statusOptions[0];
        return `<span class="status-badge ${option.class}">${option.label}</span>`;
    }

    window.updateOrderStatus = async (orderId, newStatus) => {
        try {
            const orderRef = database.ref('orders/' + orderId);
            const snapshot = await orderRef.once('value');
            const order = snapshot.val();

            const statusHistory = order.status_history || [];
            statusHistory.push({
                status: newStatus,
                timestamp: new Date().toISOString(),
                note: `Status updated to ${newStatus} by admin`
            });

            await orderRef.update({
                status: newStatus,
                updated_at: new Date().toISOString(),
                status_history: statusHistory
            });

            alert('Order status updated successfully!');
            
            if (document.getElementById('payment-verification').style.display !== 'none') {
                loadPaymentVerification();
            } else if (document.getElementById('orders').style.display !== 'none') {
                loadOrders(currentFilter);
            }
            loadAnalytics();
            loadDashboard();
            
        } catch (error) {
            console.error('Error updating status:', error);
            alert('Failed to update status');
        }
    };

    window.deleteOrder = async (orderId) => {
        if(confirm("Are you sure you want to delete this order?")) {
            try {
                await database.ref('orders/' + orderId).remove();
                alert("Order deleted successfully!");
                loadOrders(currentFilter);
                loadAnalytics();
                loadDashboard();
            } catch (error) {
                console.error('Error deleting order:', error);
                alert("Failed to delete order");
            }
        }
    };

    // ========== PAYMENT VERIFICATION ==========
    window.verifyPayment = async (orderId) => {
        try {
            const orderRef = database.ref('orders/' + orderId);
            const snapshot = await orderRef.once('value');
            const order = snapshot.val();

            const statusHistory = order.status_history || [];
            statusHistory.push({
                status: 'placed',
                timestamp: new Date().toISOString(),
                note: `Payment verified by admin. Transaction ID: ${order.payment?.trxId || 'N/A'}`
            });

            await orderRef.update({
                'payment.status': 'paid',
                'payment.verified_at': new Date().toISOString(),
                'payment.verified_by': 'admin',
                status: 'placed',
                updated_at: new Date().toISOString(),
                status_history: statusHistory
            });

            alert('Payment verified! Order status set to "Order Placed"');
            loadPaymentVerification();
            loadAnalytics();
            loadDashboard();
            
        } catch (error) {
            console.error('Error verifying payment:', error);
            alert('Failed to verify payment');
        }
    };

    function loadPaymentVerification() {
        database.ref('orders').once('value', (snapshot) => {
            const list = document.getElementById('paymentVerificationList');
            list.innerHTML = '';
            let pendingCount = 0;

            snapshot.forEach(child => {
                const order = child.val();
                const payment = order.payment || {};
                
                if (payment.method !== 'cod' && payment.status === 'awaiting_verification') {
                    pendingCount++;
                    list.innerHTML += `
                        <tr>
                            <td><strong>${child.key}</strong></td>
                            <td>
                                ${order.customer?.name || 'N/A'}<br>
                                <small class="text-muted">${order.customer?.phone || ''}</small>
                            </td>
                            <td>‡ß≥ ${order.total?.toFixed(0) || '0'}</td>
                            <td>
                                ${payment.method === 'bkash' 
                                    ? '<span style="color: #E2136E;"><i class="fab fa-bkash"></i> bKash</span>' 
                                    : '<span style="color: #F15A24;"><i class="fas fa-coins"></i> Nagad</span>'}
                            </td>
                            <td>
                                <strong>${payment.trxId || 'N/A'}</strong><br>
                                <small>${payment.number || ''}</small>
                            </td>
                            <td>
                                <span class="status-badge status-pending">
                                    <i class="fas fa-clock"></i> Awaiting
                                </span>
                            </td>
                            <td>
                                <button class="verify-btn" onclick="verifyPayment('${child.key}')">
                                    <i class="fas fa-check"></i> Verify
                                </button>
                            </td>
                        </tr>
                    `;
                }
            });

            if (pendingCount === 0) {
                list.innerHTML = '<tr><td colspan="7" class="text-center py-4">No pending verifications</td></tr>';
            }

            document.getElementById('pendingPaymentCount').innerText = pendingCount;
            document.getElementById('pendingVerificationCount').innerText = pendingCount;
        });
    }

    // ========== ORDERS ==========
    window.filterOrders = (status, btn) => {
        currentFilter = status;
        loadOrders(status);
        
        document.querySelectorAll('#orders .filter-btn').forEach(b => {
            b.classList.remove('active');
        });
        btn.classList.add('active');
    };

    function loadOrders(statusFilter = 'all') {
        database.ref('orders').once('value', (snapshot) => {
            const list = document.getElementById('orderList');
            list.innerHTML = '';

            snapshot.forEach(child => {
                const order = child.val();
                
                if (statusFilter === 'all' || order.status === statusFilter) {
                    const payment = order.payment || {};
                    const paymentMethod = payment.method || 'cod';
                    
                    list.innerHTML += `
                        <tr>
                            <td><strong>${child.key}</strong></td>
                            <td>
                                ${order.customer?.name || 'N/A'}<br>
                                <small class="text-muted">${order.customer?.phone || ''}</small>
                            </td>
                            <td>‡ß≥ ${order.total?.toFixed(0) || '0'}</td>
                            <td>
                                ${paymentMethod === 'bkash' ? '<span style="color: #E2136E;"><i class="fab fa-bkash"></i> bKash</span>' : 
                                  paymentMethod === 'nagad' ? '<span style="color: #F15A24;"><i class="fas fa-coins"></i> Nagad</span>' : 
                                  '<span><i class="fas fa-money-bill-wave"></i> COD</span>'}
                                ${payment.status === 'paid' ? '<span class="badge bg-success ms-1">Paid</span>' : 
                                  payment.status === 'awaiting_verification' ? '<span class="badge bg-warning ms-1">Awaiting</span>' : ''}
                            </td>
                            <td>${getStatusBadge(order.status || 'pending')}</td>
                            <td>${new Date(order.created_at).toLocaleDateString()}</td>
                            <td>
                                <select class="form-select form-select-sm mb-1" onchange="updateOrderStatus('${child.key}', this.value)">
                                    ${statusOptions.map(opt => `
                                        <option value="${opt.value}" ${order.status === opt.value ? 'selected' : ''}>
                                            ${opt.label}
                                        </option>
                                    `).join('')}
                                </select>
                                <button class="btn btn-sm btn-outline-danger mt-1" onclick="deleteOrder('${child.key}')">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }
            });
        });
    }

    // ========== PAYMENT FILTER ==========
    window.filterPayments = (method, btn) => {
        loadPaymentVerification();
        
        document.querySelectorAll('#payment-verification .filter-btn').forEach(b => {
            b.classList.remove('active');
        });
        btn.classList.add('active');
    };

    // ========== DASHBOARD ==========
    function loadDashboard() {
        database.ref('orders').once('value', (snapshot) => {
            let totalOrders = 0;
            let pendingVerification = 0;
            let processingCount = 0;
            let completedCount = 0;
            let totalRevenue = 0;
            let todayOrders = 0;
            let recentOrders = [];
            const today = new Date().toDateString();

            snapshot.forEach(child => {
                totalOrders++;
                const order = child.val();
                
                if (order.payment?.status === 'awaiting_verification') pendingVerification++;
                if (order.status === 'processing') processingCount++;
                if (order.status === 'completed') {
                    completedCount++;
                    totalRevenue += order.total || 0;
                }
                
                if (new Date(order.created_at).toDateString() === today) {
                    todayOrders++;
                }
                
                if (recentOrders.length < 5) {
                    recentOrders.push({ id: child.key, ...order });
                }
            });

            document.getElementById('totalOrders').innerText = totalOrders;
            document.getElementById('pendingVerificationCount').innerText = pendingVerification;
            document.getElementById('processingCount').innerText = processingCount;
            document.getElementById('completedCount').innerText = completedCount;
            document.getElementById('totalRevenue').innerText = `‡ß≥${totalRevenue.toFixed(0)}`;
            document.getElementById('todayOrders').innerText = todayOrders;
            document.getElementById('avgOrderValue').innerText = totalOrders > 0 ? `‡ß≥${(totalRevenue/totalOrders).toFixed(0)}` : '‡ß≥0';

            const recentList = document.getElementById('recentOrdersList');
            recentList.innerHTML = '';
            recentOrders.forEach(order => {
                recentList.innerHTML += `
                    <tr>
                        <td>${order.id}</td>
                        <td>${order.customer?.name || 'N/A'}</td>
                        <td>‡ß≥ ${order.total?.toFixed(0) || '0'}</td>
                        <td>${order.payment?.method || 'cod'}</td>
                        <td>${getStatusBadge(order.status || 'pending')}</td>
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                    </tr>
                `;
            });
        });
    }

    // ========== ANALYTICS ==========
    function loadAnalytics() {
        database.ref('orders').once('value', (snapshot) => {
            let totalRevenue = 0;
            let totalOrders = 0;
            let paymentMethods = { bkash: 0, nagad: 0, cod: 0 };
            let orderStatus = { pending: 0, placed: 0, processing: 0, shipping: 0, completed: 0, cancelled: 0 };
            let productSales = {};
            let monthlyData = {};

            snapshot.forEach(child => {
                totalOrders++;
                const order = child.val();
                
                if (order.status === 'completed') {
                    totalRevenue += order.total || 0;
                }
                
                const method = order.payment?.method || 'cod';
                paymentMethods[method] = (paymentMethods[method] || 0) + 1;
                
                const status = order.status || 'pending';
                orderStatus[status] = (orderStatus[status] || 0) + 1;
                
                const month = new Date(order.created_at).toLocaleString('default', { month: 'short' });
                monthlyData[month] = (monthlyData[month] || 0) + 1;
                
                if (order.items) {
                    order.items.forEach(item => {
                        const productName = item.name;
                        productSales[productName] = (productSales[productName] || 0) + item.quantity;
                    });
                }
            });

            document.getElementById('analyticsRevenue').innerHTML = `‡ß≥${totalRevenue.toFixed(0)}`;
            document.getElementById('analyticsOrders').innerText = totalOrders;
            document.getElementById('conversionRate').innerText = totalOrders > 0 ? '75%' : '0%';

            // Payment Methods Stats
            const paymentStats = document.getElementById('paymentStats');
            paymentStats.innerHTML = `
                <div class="d-flex justify-content-between mb-1">
                    <span>bKash:</span> <strong>${paymentMethods.bkash || 0}</strong>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>Nagad:</span> <strong>${paymentMethods.nagad || 0}</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>COD:</span> <strong>${paymentMethods.cod || 0}</strong>
                </div>
            `;

            // Status Stats
            const statusStats = document.getElementById('statusStats');
            statusStats.innerHTML = `
                <div class="d-flex justify-content-between mb-1">
                    <span>‚è≥ Pending:</span> <strong>${orderStatus.pending || 0}</strong>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>üì¶ Placed:</span> <strong>${orderStatus.placed || 0}</strong>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>‚öôÔ∏è Processing:</span> <strong>${orderStatus.processing || 0}</strong>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>üöö Shipping:</span> <strong>${orderStatus.shipping || 0}</strong>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>‚úÖ Completed:</span> <strong>${orderStatus.completed || 0}</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>‚ùå Cancelled:</span> <strong>${orderStatus.cancelled || 0}</strong>
                </div>
            `;

            // Top Products
            const topProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const topProductsList = document.getElementById('topProductsList');
            topProductsList.innerHTML = topProducts.length > 0 
                ? topProducts.map(([name, qty]) => `
                    <div class="d-flex justify-content-between mb-2">
                        <span>${name}</span>
                        <strong>${qty} sold</strong>
                    </div>
                `).join('')
                : '<p class="text-muted">No sales data yet</p>';

            // Charts
            if (ordersChart) ordersChart.destroy();
            if (revenueChart) revenueChart.destroy();
            if (paymentChart) paymentChart.destroy();
            if (statusChart) statusChart.destroy();

            ordersChart = new Chart(document.getElementById('ordersChart'), {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Orders',
                        data: [12, 19, 15, 25, 22, 30],
                        borderColor: '#ff385c',
                        tension: 0.4
                    }]
                },
                options: { responsive: true }
            });

            revenueChart = new Chart(document.getElementById('revenueChart'), {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Revenue (‡ß≥)',
                        data: [15000, 22000, 18000, 28000, 25000, 35000],
                        backgroundColor: '#ff385c'
                    }]
                },
                options: { responsive: true }
            });

            paymentChart = new Chart(document.getElementById('paymentChart'), {
                type: 'doughnut',
                data: {
                    labels: ['bKash', 'Nagad', 'COD'],
                    datasets: [{
                        data: [paymentMethods.bkash || 1, paymentMethods.nagad || 1, paymentMethods.cod || 1],
                        backgroundColor: ['#E2136E', '#F15A24', '#333']
                    }]
                },
                options: { responsive: true }
            });

            statusChart = new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Placed', 'Processing', 'Shipping', 'Completed', 'Cancelled'],
                    datasets: [{
                        data: [
                            orderStatus.pending || 1,
                            orderStatus.placed || 1,
                            orderStatus.processing || 1,
                            orderStatus.shipping || 1,
                            orderStatus.completed || 1,
                            orderStatus.cancelled || 1
                        ],
                        backgroundColor: ['#ffc107', '#28a745', '#17a2b8', '#007bff', '#28a745', '#dc3545']
                    }]
                },
                options: { responsive: true }
            });
        });
    }

    // Initialize
    function init() {
        loadCategories();
        loadProducts();
        loadOrders('all');
        loadPaymentVerification();
        loadDashboard();
        loadAnalytics();
    }

    init();
</script>
</body>
    </html>
