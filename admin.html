<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin | Espera Mavro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root { 
            --dark: #111; 
            --bg: #f8f9fa;
            --primary: #000000;
            --accent: #ff385c;
            --success: #2e7d32;
            --warning: #ed6c02;
            --info: #0288d1;
            --danger: #d32f2f;
        }
        
        body { background: var(--bg); font-family: 'Inter', sans-serif; }
        
        .sidebar { 
            background: #fff; 
            height: 100vh; 
            position: fixed; 
            width: 280px; 
            border-right: 1px solid #ddd; 
            padding: 25px; 
            z-index: 100; 
            overflow-y: auto; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.02);
        }
        
        .main { 
            margin-left: 280px; 
            padding: 30px; 
        }
        
        @media (max-width: 768px) { 
            .sidebar { 
                height: auto; 
                width: 100%; 
                position: relative; 
            } 
            .main { 
                margin-left: 0; 
                padding: 15px; 
            } 
        }
        
        .card-custom { 
            background: #fff; 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); 
            margin-bottom: 25px; 
            border: 1px solid #eee; 
        }
        
        .nav-link { 
            color: #333; 
            padding: 12px 15px; 
            border-radius: 12px; 
            margin-bottom: 5px; 
            cursor: pointer; 
            text-decoration: none; 
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
        }
        
        .nav-link:hover { 
            background: #f5f5f5; 
        }
        
        .nav-link.active { 
            background: var(--primary); 
            color: #fff; 
        }
        
        .nav-link i { 
            width: 24px; 
            font-size: 18px; 
        }

        .product-img { 
            width: 50px; 
            height: 65px; 
            object-fit: cover; 
            border-radius: 8px; 
            background: #eee; 
        }

        .gallery-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-top: 15px; 
        }

        .gallery-item { 
            position: relative; 
            width: 70px; 
            height: 70px; 
        }

        .gallery-item img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            border-radius: 8px; 
            border: 1px solid #ddd; 
        }

        .remove-btn { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            background: #ff4d4d; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 22px; 
            height: 22px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
        }

        .upload-trigger { 
            border: 2px dashed #000; 
            padding: 15px; 
            border-radius: 10px; 
            text-align: center; 
            cursor: pointer; 
            background: #fff; 
            font-weight: bold; 
        }

        #editor { 
            height: 300px; 
            background: white; 
        }
        
        .status-badge { 
            padding: 6px 12px; 
            border-radius: 50px; 
            font-size: 12px; 
            font-weight: 600; 
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-pending { 
            background: #fff3cd; 
            color: #856404; 
        }
        
        .status-placed { 
            background: #d4edda; 
            color: #155724; 
        }
        
        .status-processing { 
            background: #cce5ff; 
            color: #004085; 
        }
        
        .status-shipping { 
            background: #d1ecf1; 
            color: #0c5460; 
        }
        
        .status-completed { 
            background: #d4edda; 
            color: #155724; 
        }
        
        .status-cancelled { 
            background: #f8d7da; 
            color: #721c24; 
        }
        
        .status-awaiting_verification { 
            background: #fff3cd; 
            color: #856404; 
            border-left: 3px solid var(--warning);
        }
        
        .payment-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
        }
        
        .payment-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
        }
        
        .payment-detail:last-child {
            border-bottom: none;
        }
        
        .verify-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .verify-btn:hover {
            background: #1e5622;
        }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border-radius: 30px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            transition: 0.2s;
            font-size: 13px;
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
    </style>
</head>
<body>

<div class="sidebar">
    <h4 class="mb-4 fw-bold text-center">ESPERA <span style="color: var(--accent);">MAVRO</span></h4>
    <p class="text-center small text-muted mb-4">Master Admin Panel</p>
    
    <nav class="nav flex-column">
        <a class="nav-link active" onclick="showSection('dashboard', this)">
            <i class="fa fa-dashboard"></i> Dashboard
        </a>
        <a class="nav-link" onclick="showSection('products', this)">
            <i class="fa fa-box"></i> Products
        </a>
        <a class="nav-link" onclick="showSection('categories', this)">
            <i class="fa fa-list"></i> Categories
        </a>
        <a class="nav-link" onclick="showSection('orders', this)">
            <i class="fa fa-shopping-cart"></i> Orders
        </a>
        <a class="nav-link" onclick="showSection('payment-verification', this)">
            <i class="fa fa-check-circle"></i> Payment Verification
            <span class="badge bg-danger ms-auto" id="pendingPaymentCount">0</span>
        </a>
    </nav>
</div>

<div class="main">
    <!-- Dashboard -->
    <div id="dashboard" class="section">
        <h3 class="mb-4">Dashboard Overview</h3>
        <div class="row g-4">
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Total Products</h6>
                    <h2 id="totalProducts">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Total Orders</h6>
                    <h2 id="totalOrders">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Pending Verification</h6>
                    <h2 id="pendingVerificationCount">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-muted">Processing Orders</h6>
                    <h2 id="processingCount">0</h2>
                </div>
            </div>
        </div>
        
        <div class="card-custom mt-4">
            <h5>Recent Orders</h5>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Payment</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="recentOrdersList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Products Section (Restored) -->
    <div id="products" class="section" style="display: none;">
        <div class="card-custom">
            <h5 class="mb-4 fw-bold">Publish New Product</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="small fw-bold">Product Name *</label>
                    <input type="text" id="pName" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold">SKU *</label>
                    <input type="text" id="pSku" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold">Price (à§³) *</label>
                    <input type="number" id="pPrice" class="form-control">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Category</label>
                    <select id="pCatSel" class="form-select">
                        <option value="">Select Category</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold">Main Image *</label>
                    <input type="file" id="pImg" class="form-control" accept="image/*">
                </div>
                <div class="col-12">
                    <label class="small fw-bold">Gallery Images</label>
                    <div class="upload-trigger" onclick="document.getElementById('galleryInput').click()">+ Add Gallery Images</div>
                    <input type="file" id="galleryInput" class="d-none" multiple accept="image/*">
                    <div id="galleryContainer" class="gallery-container"></div>
                </div>
                <div class="col-12">
                    <h5>Variations</h5>
                    <button class="btn btn-sm btn-outline-dark mb-2" onclick="addVariation()">+ Add Variation</button>
                    <div id="variationsContainer"></div>
                </div>
                <div class="col-12">
                    <label class="small fw-bold">Description</label>
                    <div id="editor"></div>
                </div>
                <div class="col-12">
                    <button id="savePBtn" class="btn btn-dark w-100 py-3 mt-3 fw-bold">PUBLISH PRODUCT</button>
                </div>
            </div>
        </div>

        <div class="card-custom">
            <h5>Live Inventory</h5>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Price</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="pList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Categories Section (Restored) -->
    <div id="categories" class="section" style="display: none;">
        <div class="card-custom">
            <h5>Manage Categories</h5>
            <div class="input-group mb-3">
                <input type="text" id="catName" class="form-control" placeholder="Category Name">
                <button id="saveCatBtn" class="btn btn-dark">Add Category</button>
            </div>
            <div id="catList" class="d-flex flex-wrap gap-2"></div>
        </div>
    </div>

    <!-- Payment Verification Section -->
    <div id="payment-verification" class="section" style="display: none;">
        <h3 class="mb-4">Payment Verification</h3>
        
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterPayments('all', this)">All</button>
            <button class="filter-btn" onclick="filterPayments('bkash', this)">bKash</button>
            <button class="filter-btn" onclick="filterPayments('nagad', this)">Nagad</button>
        </div>
        
        <div class="card-custom">
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Payment Method</th>
                            <th>Transaction ID</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="paymentVerificationList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Orders Section -->
    <div id="orders" class="section" style="display: none;">
        <h3 class="mb-4">Order Management</h3>
        
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterOrders('all', this)">All</button>
            <button class="filter-btn" onclick="filterOrders('pending', this)">Pending</button>
            <button class="filter-btn" onclick="filterOrders('placed', this)">Order Placed</button>
            <button class="filter-btn" onclick="filterOrders('processing', this)">Processing</button>
            <button class="filter-btn" onclick="filterOrders('shipping', this)">Shipping</button>
            <button class="filter-btn" onclick="filterOrders('completed', this)">Completed</button>
            <button class="filter-btn" onclick="filterOrders('cancelled', this)">Cancelled</button>
        </div>
        
        <div class="card-custom">
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Payment</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="orderList"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAB7dyaJwkadV7asGOhj6TCN5it5pCWg10",
        authDomain: "espera-mavro-6ddc5.firebaseapp.com",
        databaseURL: "https://espera-mavro-6ddc5-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "espera-mavro-6ddc5",
        storageBucket: "espera-mavro-6ddc5.appspot.com",
        messagingSenderId: "137893255543",
        appId: "1:137893255543:web:a660bd412eb26ee322a972"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Initialize Quill
    const quill = new Quill('#editor', { theme: 'snow' });
    
    // State
    let galleryArr = [];
    let variations = [];
    let currentFilter = 'all';

    // Navigation
    window.showSection = (id, el) => {
        document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        el.classList.add('active');
        
        // Refresh data when section changes
        if (id === 'products') loadProducts();
        if (id === 'categories') loadCategories();
        if (id === 'payment-verification') loadPaymentVerification();
        if (id === 'orders') loadOrders('all');
    };

    // ========== IMAGE HANDLING ==========
    const toBase64 = f => new Promise((res) => {
        const r = new FileReader(); 
        r.readAsDataURL(f); 
        r.onload = () => res(r.result);
    });

    document.getElementById('galleryInput').onchange = async (e) => {
        for(let f of e.target.files) { 
            galleryArr.push(await toBase64(f)); 
        }
        renderGallery();
    };

    function renderGallery() {
        const container = document.getElementById('galleryContainer');
        container.innerHTML = galleryArr.map((s, i) => `
            <div class="gallery-item">
                <img src="${s}">
                <button class="remove-btn" onclick="galleryArr.splice(${i},1);renderGallery()">Ã—</button>
            </div>
        `).join('');
    }

    // ========== VARIATIONS ==========
    window.addVariation = () => {
        variations.push({ name: '', value: '', price: '' });
        renderVariations();
    };

    function renderVariations() {
        const container = document.getElementById('variationsContainer');
        container.innerHTML = variations.map((v, i) => `
            <div class="variation-row" style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                <div class="row g-2">
                    <div class="col-md-4">
                        <input type="text" class="form-control" placeholder="Type (e.g., Color)" value="${v.name}" onchange="updateVariation(${i}, 'name', this.value)">
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" placeholder="Value (e.g., Red)" value="${v.value}" onchange="updateVariation(${i}, 'value', this.value)">
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control" placeholder="Price" value="${v.price}" onchange="updateVariation(${i}, 'price', this.value)">
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-outline-danger" onclick="removeVariation(${i})">Ã—</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    window.updateVariation = (index, field, value) => {
        variations[index][field] = value;
    };

    window.removeVariation = (index) => {
        variations.splice(index, 1);
        renderVariations();
    };

    // ========== CATEGORIES ==========
    document.getElementById('saveCatBtn').onclick = async () => {
        const name = document.getElementById('catName').value.trim();
        if(name) { 
            await database.ref('categories').push({ name }); 
            document.getElementById('catName').value = ""; 
        }
    };

    function loadCategories() {
        database.ref('categories').on('value', snap => {
            const sel = document.getElementById('pCatSel');
            const list = document.getElementById('catList');
            sel.innerHTML = '<option value="">Select Category</option>';
            list.innerHTML = "";
            
            snap.forEach(child => {
                const c = child.val();
                const catName = c.name || c;
                sel.innerHTML += `<option value="${catName}">${catName}</option>`;
                list.innerHTML += `<span class="badge bg-dark p-2">${catName} <i class="fa fa-times ms-2" style="cursor:pointer" onclick="deleteCat('${child.key}')"></i></span>`;
            });
        });
    }

    window.deleteCat = (id) => {
        if(confirm('Delete this category?')) {
            database.ref('categories/'+id).remove();
        }
    };

    // ========== PRODUCTS ==========
    document.getElementById('savePBtn').onclick = async () => {
        const btn = document.getElementById('savePBtn');
        const name = document.getElementById('pName').value.trim();
        const sku = document.getElementById('pSku').value.trim();
        const price = document.getElementById('pPrice').value;
        const category = document.getElementById('pCatSel').value;
        const mainImgFile = document.getElementById('pImg').files[0];
        
        if(!name || !mainImgFile || !price) {
            alert("Please fill all required fields!");
            return;
        }
        
        btn.disabled = true; 
        btn.innerText = "Publishing...";
        
        // Create variations array
        const variationsData = {};
        variations.forEach((v, idx) => {
            if (v.name && v.value) {
                variationsData[`var_${idx}`] = {
                    name: v.name,
                    value: v.value,
                    price: v.price || price
                };
            }
        });
        
        const pData = {
            name: name,
            title: name,
            sku: sku,
            price: parseFloat(price),
            category: category,
            description: quill.root.innerHTML,
            image: await toBase64(mainImgFile),
            images: [await toBase64(mainImgFile), ...galleryArr],
            variations: Object.keys(variationsData).length > 0 ? variationsData : null,
            created_at: new Date().toISOString()
        };
        
        try {
            await database.ref('products').push(pData);
            alert("Product published successfully!");
            location.reload();
        } catch (error) {
            alert("Error: " + error.message);
            btn.disabled = false;
            btn.innerText = "PUBLISH PRODUCT";
        }
    };

    function loadProducts() {
        database.ref('products').on('value', snap => {
            const list = document.getElementById('pList');
            const totalElement = document.getElementById('totalProducts');
            list.innerHTML = "";
            let count = 0;
            
            snap.forEach(child => {
                count++;
                const p = child.val();
                const productName = p.name || p.title || 'No Name';
                const productImg = p.image || (p.images ? p.images[0] : 'https://via.placeholder.com/50');
                
                list.innerHTML += `
                    <tr>
                        <td><img src="${productImg}" class="product-img" onerror="this.src='https://via.placeholder.com/50'"></td>
                        <td>
                            <strong>${productName}</strong><br>
                            <small class="text-muted">${child.key}</small>
                        </td>
                        <td>${p.sku || '-'}</td>
                        <td>à§³${p.price || '0'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${child.key}')">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            totalElement.innerText = count;
        });
    }

    window.deleteProduct = (id) => {
        if(confirm("Delete this product?")) {
            database.ref('products/'+id).remove();
        }
    };

    // ========== ORDER STATUS ==========
    const statusOptions = [
        { value: 'pending', label: 'â³ Pending', class: 'status-pending' },
        { value: 'placed', label: 'ðŸ“¦ Order Placed', class: 'status-placed' },
        { value: 'processing', label: 'âš™ï¸ Processing', class: 'status-processing' },
        { value: 'shipping', label: 'ðŸšš Shipping', class: 'status-shipping' },
        { value: 'completed', label: 'âœ… Completed', class: 'status-completed' },
        { value: 'cancelled', label: 'âŒ Cancelled', class: 'status-cancelled' }
    ];

    function getStatusBadge(status) {
        const option = statusOptions.find(opt => opt.value === status) || statusOptions[0];
        return `<span class="status-badge ${option.class}">${option.label}</span>`;
    }

    window.updateOrderStatus = async (orderId, newStatus) => {
        try {
            const orderRef = database.ref('orders/' + orderId);
            const snapshot = await orderRef.once('value');
            const order = snapshot.val();

            const statusHistory = order.status_history || [];
            statusHistory.push({
                status: newStatus,
                timestamp: new Date().toISOString(),
                note: `Status updated to ${newStatus} by admin`
            });

            await orderRef.update({
                status: newStatus,
                updated_at: new Date().toISOString(),
                status_history: statusHistory
            });

            alert('Order status updated successfully!');
            
            // Refresh current view
            if (document.getElementById('payment-verification').style.display !== 'none') {
                loadPaymentVerification();
            } else if (document.getElementById('orders').style.display !== 'none') {
                loadOrders(currentFilter);
            }
            
        } catch (error) {
            console.error('Error updating status:', error);
            alert('Failed to update status');
        }
    };

    // ========== PAYMENT VERIFICATION ==========
    window.verifyPayment = async (orderId) => {
        try {
            const orderRef = database.ref('orders/' + orderId);
            const snapshot = await orderRef.once('value');
            const order = snapshot.val();

            const statusHistory = order.status_history || [];
            statusHistory.push({
                status: 'placed',
                timestamp: new Date().toISOString(),
                note: `Payment verified by admin. Transaction ID: ${order.payment?.trxId || 'N/A'}`
            });

            await orderRef.update({
                'payment.status': 'paid',
                'payment.verified_at': new Date().toISOString(),
                'payment.verified_by': 'admin',
                status: 'placed',
                updated_at: new Date().toISOString(),
                status_history: statusHistory
            });

            alert('Payment verified! Order status set to "Order Placed"');
            loadPaymentVerification();
            
        } catch (error) {
            console.error('Error verifying payment:', error);
            alert('Failed to verify payment');
        }
    };

    // Load payment verification list
    function loadPaymentVerification() {
        database.ref('orders').once('value', (snapshot) => {
            const list = document.getElementById('paymentVerificationList');
            list.innerHTML = '';
            let pendingCount = 0;

            snapshot.forEach(child => {
                const order = child.val();
                const payment = order.payment || {};
                
                if (payment.method !== 'cod' && payment.status === 'awaiting_verification') {
                    pendingCount++;
                    list.innerHTML += `
                        <tr>
                            <td><strong>${child.key}</strong></td>
                            <td>
                                ${order.customer?.name || 'N/A'}<br>
                                <small class="text-muted">${order.customer?.phone || ''}</small>
                            </td>
                            <td>à§³ ${order.total?.toFixed(0) || '0'}</td>
                            <td>
                                ${payment.method === 'bkash' 
                                    ? '<span style="color: #E2136E;"><i class="fab fa-bkash"></i> bKash</span>' 
                                    : '<span style="color: #F15A24;"><i class="fas fa-coins"></i> Nagad</span>'}
                            </td>
                            <td>
                                <strong>${payment.trxId || 'N/A'}</strong><br>
                                <small>${payment.number || ''}</small>
                            </td>
                            <td>
                                <span class="status-badge status-pending">
                                    <i class="fas fa-clock"></i> Awaiting
                                </span>
                            </td>
                            <td>
                                <button class="verify-btn" onclick="verifyPayment('${child.key}')">
                                    <i class="fas fa-check"></i> Verify
                                </button>
                            </td>
                        </tr>
                    `;
                }
            });

            if (pendingCount === 0) {
                list.innerHTML = '<tr><td colspan="7" class="text-center py-4">No pending verifications</td></tr>';
            }

            document.getElementById('pendingPaymentCount').innerText = pendingCount;
            document.getElementById('pendingVerificationCount').innerText = pendingCount;
        });
    }

    // ========== ORDERS ==========
    window.filterOrders = (status, btn) => {
        currentFilter = status;
        loadOrders(status);
        
        document.querySelectorAll('#orders .filter-btn').forEach(b => {
            b.classList.remove('active');
        });
        btn.classList.add('active');
    };

    function loadOrders(statusFilter = 'all') {
        database.ref('orders').once('value', (snapshot) => {
            const list = document.getElementById('orderList');
            const recentList = document.getElementById('recentOrdersList');
            list.innerHTML = '';
            recentList.innerHTML = '';

            let totalOrders = 0;
            let processingCount = 0;
            let pendingCount = 0;
            let recentOrders = [];

            snapshot.forEach(child => {
                totalOrders++;
                const order = child.val();
                
                // Count for dashboard
                if (order.status === 'processing') processingCount++;
                if (order.status === 'pending' && order.payment?.status === 'awaiting_verification') pendingCount++;
                
                // For recent orders (last 5)
                if (recentOrders.length < 5) {
                    recentOrders.push({ id: child.key, ...order });
                }

                // Filter for main order list
                if (statusFilter === 'all' || order.status === statusFilter) {
                    const payment = order.payment || {};
                    const paymentMethod = payment.method || 'cod';
                    
                    list.innerHTML += `
                        <tr>
                            <td><strong>${child.key}</strong></td>
                            <td>
                                ${order.customer?.name || 'N/A'}<br>
                                <small class="text-muted">${order.customer?.phone || ''}</small>
                            </td>
                            <td>à§³ ${order.total?.toFixed(0) || '0'}</td>
                            <td>
                                ${paymentMethod === 'bkash' ? '<span style="color: #E2136E;"><i class="fab fa-bkash"></i> bKash</span>' : 
                                  paymentMethod === 'nagad' ? '<span style="color: #F15A24;"><i class="fas fa-coins"></i> Nagad</span>' : 
                                  '<span><i class="fas fa-money-bill-wave"></i> COD</span>'}
                                ${payment.status === 'paid' ? '<span class="badge bg-success ms-1">Paid</span>' : 
                                  payment.status === 'awaiting_verification' ? '<span class="badge bg-warning ms-1">Awaiting</span>' : ''}
                            </td>
                            <td>${getStatusBadge(order.status || 'pending')}</td>
                            <td>
                                <select class="form-select form-select-sm" onchange="updateOrderStatus('${child.key}', this.value)">
                                    ${statusOptions.map(opt => `
                                        <option value="${opt.value}" ${order.status === opt.value ? 'selected' : ''}>
                                            ${opt.label}
                                        </option>
                                    `).join('')}
                                </select>
                            </td>
                        </tr>
                    `;
                }
            });

            // Update dashboard counts
            document.getElementById('totalOrders').innerText = totalOrders;
            document.getElementById('processingCount').innerText = processingCount;

            // Load recent orders
            recentOrders.forEach(order => {
                recentList.innerHTML += `
                    <tr>
                        <td>${order.id}</td>
                        <td>${order.customer?.name || 'N/A'}</td>
                        <td>à§³ ${order.total?.toFixed(0) || '0'}</td>
                        <td>${order.payment?.method || 'cod'}</td>
                        <td>${getStatusBadge(order.status || 'pending')}</td>
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                    </tr>
                `;
            });
        });
    }

    // ========== PAYMENT FILTER ==========
    window.filterPayments = (method, btn) => {
        loadPaymentVerification();
        
        document.querySelectorAll('#payment-verification .filter-btn').forEach(b => {
            b.classList.remove('active');
        });
        btn.classList.add('active');
    };

    // Initialize
    function init() {
        loadCategories();
        loadProducts();
        loadOrders('all');
        loadPaymentVerification();
    }

    init();
</script>
</body>
</html>