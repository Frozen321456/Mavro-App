<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin | Mavro Essence</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root { --dark: #111; --bg: #f8f9fa; }
        body { background: var(--bg); font-family: 'Inter', sans-serif; }
        .sidebar { background: #fff; height: 100vh; position: fixed; width: 250px; border-right: 1px solid #ddd; padding: 20px; z-index: 100; overflow-y: auto; }
        .main { margin-left: 250px; padding: 30px; }
        @media (max-width: 768px) { .sidebar { height: auto; width: 100%; position: relative; } .main { margin-left: 0; padding: 15px; } }
        .card-custom { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 25px; border: none; }
        .nav-link { color: #333; padding: 12px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; display: block; text-decoration: none; }
        .nav-link.active { background: #111; color: #fff; }
        #editor { height: 300px; background: white; }
        .preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .preview-item { position: relative; width: 80px; height: 80px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-btn { position: absolute; top: 2px; right: 2px; background: rgba(255,0,0,0.8); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; }
        .dynamic-row { background: #f9f9f9; padding: 12px; border: 1px dashed #ccc; border-radius: 8px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h4 class="mb-4 fw-bold text-center">MAVRO ADMIN</h4>
    <nav class="nav flex-column">
        <a onclick="showSection('dashboard')" class="nav-link active"><i class="fa fa-dashboard me-2"></i> Dashboard</a>
        <a onclick="showSection('products')" class="nav-link"><i class="fa fa-box me-2"></i> Products</a>
        <a onclick="showSection('categories')" class="nav-link"><i class="fa fa-list me-2"></i> Categories</a>
        <a onclick="showSection('orders')" class="nav-link"><i class="fa fa-shopping-bag me-2"></i> Orders Sync</a>
    </nav>
</div>

<div class="main">
    <div id="dashboard" class="section">
        <h3 class="fw-bold mb-4">Summary</h3>
        <div class="row g-3">
            <div class="col-md-4"><div class="card-custom"><h6>Total Products</h6><h2 id="totalP">0</h2></div></div>
            <div class="col-md-4"><div class="card-custom"><h6>Orders</h6><h2 id="totalO">0</h2></div></div>
        </div>
    </div>

    <div id="products" class="section" style="display:none;">
        <div class="card-custom">
            <h5 class="mb-4 fw-bold">Publish Product</h5>
            <div class="row g-3">
                <div class="col-md-6"><label class="small fw-bold">Product Name</label><input type="text" id="pName" class="form-control"></div>
                <div class="col-md-3"><label class="small fw-bold">SKU</label><input type="text" id="pSku" class="form-control"></div>
                <div class="col-md-3"><label class="small fw-bold">Base Price</label><input type="number" id="pPrice" class="form-control"></div>
                <div class="col-md-6"><label class="small fw-bold">Category</label><select id="pCatSel" class="form-select"></select></div>
                
                <div class="col-md-6">
                    <label class="small fw-bold">Main Image</label>
                    <input type="file" id="mainImgFile" class="form-control" accept="image/*" onchange="previewMain(this)">
                    <div id="mainPreview" class="preview-container"></div>
                </div>

                <div class="col-12">
                    <label class="small fw-bold">Gallery Images (Multiple)</label>
                    <input type="file" id="galInput" class="form-control" accept="image/*" multiple onchange="handleGallery(this)">
                    <div id="galleryPreview" class="preview-container"></div>
                </div>

                <div class="col-12">
                    <label class="small fw-bold">Variations</label>
                    <button type="button" class="btn btn-sm btn-dark float-end mb-2" onclick="addVariationRow()">+ Add Size</button>
                    <div id="variationContainer"></div>
                </div>

                <div class="col-12">
                    <label class="small fw-bold">Description (Images allowed)</label>
                    <div id="editor"></div>
                </div>
                <button id="savePBtn" class="btn btn-dark w-100 py-3 fw-bold">PUBLISH EVERYTHING</button>
            </div>
        </div>
    </div>

    <div id="categories" class="section" style="display:none;">
        <div class="card-custom">
            <h5>Manage Categories</h5>
            <div class="input-group mb-3"><input type="text" id="catName" class="form-control"><button id="saveCatBtn" class="btn btn-dark">Add</button></div>
            <div id="catList"></div>
        </div>
    </div>

    <div id="orders" class="section" style="display:none;">
        <div class="card-custom"><h5>Recent Orders</h5><div class="table-responsive"><table class="table"><tbody id="orderList"></tbody></table></div></div>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
    // 1. Full Config & Setup
    const firebaseConfig = {
        apiKey: "AIzaSyAB7dyaJwkadV7asGOhj6TCN5it5pCWg10",
        authDomain: "espera-mavro-6ddc5.firebaseapp.com",
        projectId: "espera-mavro-6ddc5",
        storageBucket: "espera-mavro-6ddc5.appspot.com",
        messagingSenderId: "137893255543",
        appId: "1:137893255543:web:a660bd412eb26ee322a972"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const IMGBB_API_KEY = '5a782e4f0d3b680c48e895844876b508';

    // 2. Quill with Image Upload Handler
    const quill = new Quill('#editor', {
        modules: { toolbar: [['bold', 'italic'], [{list:'ordered'}, {list:'bullet'}], ['image', 'link']] },
        theme: 'snow'
    });

    quill.getModule('toolbar').addHandler('image', () => {
        const input = document.createElement('input');
        input.type = 'file'; input.accept = 'image/*'; input.click();
        input.onchange = async () => {
            const url = await uploadToImgBB(input.files[0]);
            const range = quill.getSelection();
            quill.insertEmbed(range.index, 'image', url);
        };
    });

    // 3. Image Functions
    async function uploadToImgBB(file) {
        if (!file) return null;
        let fd = new FormData(); fd.append("image", file);
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: fd });
        const d = await res.json(); return d.data.url;
    }

    let selectedGalleryFiles = [];
    function previewMain(input) {
        const reader = new FileReader();
        reader.onload = e => document.getElementById('mainPreview').innerHTML = `<div class="preview-item"><img src="${e.target.result}"></div>`;
        reader.readAsDataURL(input.files[0]);
    }

    function handleGallery(input) {
        selectedGalleryFiles = [...selectedGalleryFiles, ...Array.from(input.files)];
        renderGallery(); input.value = "";
    }

    function renderGallery() {
        const cont = document.getElementById('galleryPreview'); cont.innerHTML = "";
        selectedGalleryFiles.forEach((file, i) => {
            const reader = new FileReader();
            reader.onload = e => {
                const div = document.createElement('div'); div.className="preview-item";
                div.innerHTML = `<img src="${e.target.result}"><button class="remove-btn" onclick="removeGal(${i})">×</button>`;
                cont.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    }
    function removeGal(i) { selectedGalleryFiles.splice(i, 1); renderGallery(); }

    function addVariationRow() {
        const div = document.createElement('div'); div.className = 'dynamic-row row g-2';
        div.innerHTML = `<div class="col-md-3"><input type="text" class="form-control v-size" placeholder="6ml"></div><div class="col-md-3"><input type="number" class="form-control v-price" placeholder="Price"></div><div class="col-md-5"><input type="file" class="form-control v-file"></div><div class="col-md-1"><button class="btn btn-danger w-100" onclick="this.parentElement.parentElement.remove()">×</button></div>`;
        document.getElementById('variationContainer').appendChild(div);
    }

    // 4. Save Logic
    document.getElementById('savePBtn').onclick = async () => {
        const btn = document.getElementById('savePBtn'); btn.disabled = true; btn.innerText = "Processing...";
        try {
            const mainImgUrl = await uploadToImgBB(document.getElementById('mainImgFile').files[0]);
            const galleryUrls = [];
            for(let f of selectedGalleryFiles) galleryUrls.push(await uploadToImgBB(f));
            
            const variations = [];
            for(let row of document.querySelectorAll('.dynamic-row')) {
                const vFile = row.querySelector('.v-file').files[0];
                variations.push({
                    size: row.querySelector('.v-size').value,
                    price: row.querySelector('.v-price').value,
                    image: vFile ? await uploadToImgBB(vFile) : mainImgUrl
                });
            }

            await db.collection("products").add({
                name: document.getElementById('pName').value,
                sku: document.getElementById('pSku').value,
                price: document.getElementById('pPrice').value,
                category: document.getElementById('pCatSel').value,
                image: mainImgUrl, gallery: galleryUrls, variations,
                description: quill.root.innerHTML, created_at: new Date()
            });
            alert("Success!"); location.reload();
        } catch(e) { alert(e.message); btn.disabled = false; }
    };

    // 5. Sections & Sync
    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        event.currentTarget?.classList.add('active');
    }

    db.collection("categories").onSnapshot(s => {
        const sel = document.getElementById('pCatSel'); sel.innerHTML = "";
        s.forEach(d => sel.innerHTML += `<option value="${d.data().name}">${d.data().name}</option>`);
    });

    db.collection("products").onSnapshot(s => document.getElementById('totalP').innerText = s.size);
    db.collection("orders").onSnapshot(s => {
        document.getElementById('totalO').innerText = s.size;
        const list = document.getElementById('orderList'); list.innerHTML = "";
        s.forEach(d => list.innerHTML += `<tr><td>${d.id.slice(0,5)}</td><td>${d.data().customerName}</td></tr>`);
    });
</script>
</body>
</html>
