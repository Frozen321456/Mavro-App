<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Product Details | Mavro Essence</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #000; --accent: #ff385c; --bg: #ffffff; --gray: #f7f7f7; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--primary); line-height: 1.6; overflow-x: hidden; }

        /* HEADER - Logo Centered */
        .header { 
            position: fixed; top: 0; left: 0; width: 100%; height: 65px; 
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 5%; z-index: 1000; border-bottom: 1px solid #f1f1f1; 
        }
        .logo { 
            position: absolute; left: 50%; transform: translateX(-50%);
            font-weight: 800; font-size: 18px; text-decoration: none; color: #000; letter-spacing: 1.5px; 
        }
        .nav-icon { font-size: 20px; color: #000; cursor: pointer; position: relative; z-index: 10; }
        .cart-count { position: absolute; top: -8px; right: -10px; background: var(--accent); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 50px; font-weight: 800; }

        /* MAIN CONTENT */
        .main-content { max-width: 1200px; margin: 65px auto 0; display: flex; flex-wrap: wrap; }
        .product-gallery { flex: 1.4; min-width: 50%; background: var(--gray); position: relative; }
        .slider-container { position: sticky; top: 65px; width: 100%; height: calc(100vh - 65px); overflow: hidden; display: flex; align-items: center; }
        .slider-wrapper { display: flex; transition: transform 0.6s ease; height: 100%; width: 100%; }
        .slider-wrapper img { min-width: 100%; width: 100%; height: 100%; object-fit: contain; }

        .product-details { flex: 1; min-width: 40%; padding: 60px 5%; display: flex; flex-direction: column; justify-content: center; }
        .p-title { font-size: 24px; font-weight: 800; line-height: 1.3; margin-bottom: 15px; }
        
        /* PRICE */
        .price-box { margin-bottom: 25px; display: flex; align-items: baseline; }
        .sale-p { font-size: 26px; font-weight: 800; color: var(--accent); }
        .reg-p-old { font-size: 18px; color: #888; text-decoration: line-through; margin-left: 10px; }
        .reg-p-only { font-size: 24px; font-weight: 700; }

        /* MOBILE OPTIMIZED VARIANTS */
        .v-label { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .v-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); 
            gap: 10px; 
            margin-bottom: 25px; 
        }
        .v-btn { 
            border: 1.5px solid #eee; padding: 12px 5px; border-radius: 8px; 
            font-size: 12px; font-weight: 700; text-align: center; cursor: pointer; 
            background: #fff; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .v-btn.active { background: #000; color: #fff; border-color: #000; }

        /* BUTTONS */
        .btn-black { background: #000; color: #fff; border: none; padding: 20px; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 16px; width: 100%; }
        .description-area { border-top: 1px solid #eee; padding-top: 30px; margin-top: 30px; }

        @media (max-width: 992px) {
            .main-content { flex-direction: column; }
            .slider-container { height: 65vh; position: relative; top: 0; }
            .product-details { padding: 30px 20px; }
            .p-title { font-size: 22px; }
            .v-container { grid-template-columns: repeat(4, 1fr); } /* 4 buttons per row on mobile */
        }
    </style>
</head>
<body>

    <header class="header">
        <a href="shop.html" class="nav-icon"><i class="fa-solid fa-chevron-left"></i></a>
        <a href="index.html" class="logo">MAVRO</a>
        <div class="nav-icon" onclick="location.href='cart.html'">
            <i class="fa-solid fa-bag-shopping"></i>
            <span class="cart-count" id="cartCount">0</span>
        </div>
    </header>

    <div class="main-content">
        <div class="product-gallery">
            <div class="slider-container">
                <div class="slider-wrapper" id="sliderWrapper"></div>
            </div>
        </div>

        <div class="product-details">
            <h1 class="p-title" id="pName">Loading...</h1>
            
            <div class="price-box" id="priceArea">
                <span class="reg-p-only">৳ 0</span>
            </div>
            
            <div id="variationSection" style="display:none;">
                <p class="v-label">Select Variation</p>
                <div class="v-container" id="vList"></div>
            </div>

            <button class="btn-black" id="addToCartBtn">ADD TO BAG</button>
            
            <div class="description-area">
                <h4 style="font-size: 12px; font-weight: 800; margin-bottom: 15px; text-transform: uppercase;">Product Details</h4>
                <div id="pDesc" style="font-size: 14px; color: #444;"></div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAB7dyaJwkadV7asGOhj6TCN5it5pCWg10",
            authDomain: "espera-mavro-6ddc5.firebaseapp.com",
            databaseURL: "https://espera-mavro-6ddc5-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "espera-mavro-6ddc5",
            storageBucket: "espera-mavro-6ddc5.appspot.com",
            appId: "1:137893255543:web:a660bd412eb26ee322a972"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        const pid = new URLSearchParams(window.location.search).get('id');
        let currentPrice = 0;
        let currentVar = "";

        if(pid) {
            database.ref('products/' + pid).on('value', (snapshot) => {
                const p = snapshot.val();
                if(p) {
                    document.getElementById('pName').innerText = p.title || "Mavro Product";
                    document.getElementById('pDesc').innerHTML = p.description || "";
                    
                    // স্লাইডার আপডেট
                    const wrap = document.getElementById('sliderWrapper');
                    wrap.innerHTML = "";
                    let images = p.images ? (Array.isArray(p.images) ? p.images : Object.values(p.images)) : [p.image];
                    images.forEach(img => {
                        let src = (typeof img === 'string') ? img : (img.src || img);
                        if(src) wrap.innerHTML += `<img src="${src}">`;
                    });

                    // ভ্যারিয়েশন লজিক ফিক্স
                    const vSection = document.getElementById('variationSection');
                    const vList = document.getElementById('vList');
                    vList.innerHTML = "";

                    if(p.variations) {
                        vSection.style.display = 'block';
                        const varArray = Array.isArray(p.variations) ? p.variations : Object.values(p.variations);
                        
                        varArray.forEach((v, index) => {
                            if(v) {
                                const btn = document.createElement('div');
                                btn.className = 'v-btn';
                                
                                // ভ্যারিয়েন্ট নাম ফিক্স (sku-এর বদলে নাম দেখানোর চেষ্টা)
                                let vName = v.name || v.sku || "V" + index;
                                // যদি নাম খুব বড় কোড হয়, তবে সেটি ছোট করা হয়েছে
                                btn.innerText = vName.includes('#') ? vName.split('#')[1] || vName : vName;
                                
                                if(index === 0) {
                                    btn.classList.add('active');
                                    updatePriceUI(v.regular_price, v.sale_price);
                                    currentVar = btn.innerText;
                                }

                                btn.onclick = () => {
                                    document.querySelectorAll('.v-btn').forEach(b => b.classList.remove('active'));
                                    btn.classList.add('active');
                                    updatePriceUI(v.regular_price, v.sale_price);
                                    currentVar = btn.innerText;
                                    // ভ্যারিয়েন্ট ইমেজ থাকলে স্লাইডারে নিয়ে আসা
                                    if(v.image) wrap.style.transform = `translateX(0)`; 
                                };
                                vList.appendChild(btn);
                            }
                        });
                    } else {
                        updatePriceUI(p.regular_price || p.price, p.sale_price);
                    }
                }
            });
        }

        function updatePriceUI(reg, sale) {
            const area = document.getElementById('priceArea');
            let r = (reg && reg !== "undefined") ? reg : "0";
            let s = (sale && sale !== "undefined" && sale !== "") ? sale : null;
            currentPrice = s ? s : r;
            if(s && parseFloat(s) < parseFloat(r)) {
                area.innerHTML = `<span class="sale-p">৳ ${s}</span><span class="reg-p-old">৳ ${r}</span>`;
            } else {
                area.innerHTML = `<span class="reg-p-only">৳ ${r}</span>`;
            }
        }

        document.getElementById('addToCartBtn').onclick = () => {
            let cart = JSON.parse(localStorage.getItem('essence_cart') || "[]");
            cart.push({
                id: pid,
                name: document.getElementById('pName').innerText + (currentVar ? ` (${currentVar})` : ""),
                price: currentPrice,
                image: document.querySelector('#sliderWrapper img')?.src
            });
            localStorage.setItem('essence_cart', JSON.stringify(cart));
            document.getElementById('cartCount').innerText = cart.length;
            alert("Added to Bag!");
        };

        document.getElementById('cartCount').innerText = JSON.parse(localStorage.getItem('essence_cart') || "[]").length;
    </script>
</body>
</html>
